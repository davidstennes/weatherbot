<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WeatherBot ‚Äî Compare Two Locations</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #f7f7f7; }
  h2 { margin: 0 0 10px 0; }
  .panel, .card, .chartWrap {
    background: #fff; padding: 16px; border-radius: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
  }
  .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 780px) { .row { grid-template-columns: 1fr 1fr auto; align-items: end; } }

  label { font-weight: 650; display:block; margin-bottom: 6px; }
  input {
    width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 1rem;
  }
  button {
    padding: 12px 14px; border-radius: 10px; border: none;
    background: #0077cc; color: #fff; font-weight: 700; cursor: pointer;
  }
  button:hover { opacity: .92; }

  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap: 16px; margin-top: 14px; }
  .temp { font-size: 2rem; font-weight: 900; }
  .small { font-size: .9rem; color: #666; line-height: 1.25; margin-top: 6px; }

  .actions { margin-top: 14px; }
  .wideBtn { width: 100%; font-size: 1.1rem; }

  .legend { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
  .legend-item {
    display:flex; align-items:center; gap:10px;
    background:#f4f4f4; padding:6px 10px; border-radius:10px;
    cursor:pointer; user-select:none;
  }
  .legend-line {
    width: 70px;
    height: 0;
    border-top-width: 3px;
    border-top-style: solid;
    position: relative;
  }
  .legend-dot {
    position:absolute; top:-6px; left:50%;
    transform:translateX(-50%);
    width:10px; height:10px;
    background: currentColor;
    border-radius:50%;
  }
  .legend-dot.diamond {
    border-radius: 2px;
    transform: translateX(-50%) rotate(45deg);
  }
</style>
</head>

<body>

<div id="mainView">
  <h2>WeatherBot</h2>

  <div class="panel">
    <div class="row">
      <div>
        <label>Location A</label>
        <input id="locA" value="Flagstaff">
      </div>
      <div>
        <label>Location B</label>
        <input id="locB" value="San Diego">
      </div>
      <div>
        <button onclick="compare()">Compare</button>
      </div>
    </div>
    <div id="status" class="small"></div>
  </div>

  <div class="cards">
    <div class="card">
      <h3 id="aTitle">‚Äî</h3>
      <div id="aEcho" class="small">‚Äî</div>
      <div id="aToday" class="temp">‚Äî</div>
    </div>
    <div class="card">
      <h3 id="bTitle">‚Äî</h3>
      <div id="bEcho" class="small">‚Äî</div>
      <div id="bToday" class="temp">‚Äî</div>
    </div>
  </div>

  <div class="actions">
    <button class="wideBtn" onclick="showChart()">üìà Expand chart</button>
  </div>
</div>

<div id="chartView" style="display:none;">
  <button onclick="showMain()">‚Üê Back</button>

  <div class="chartWrap" style="margin-top:12px;">
    <h3 id="chartTitle">‚Äî</h3>
    <canvas id="comboChart" height="260"></canvas>
    <div id="htmlLegend" class="legend"></div>
    <p class="small">Color = location ¬∑ Solid = high ¬∑ Dotted = low (legend)</p>
  </div>
</div>

<script>
/* ========= US State full-name -> 2-letter ========= */
const US_STATES = {
  Alabama:"AL", Alaska:"AK", Arizona:"AZ", Arkansas:"AR", California:"CA",
  Colorado:"CO", Connecticut:"CT", Delaware:"DE", Florida:"FL", Georgia:"GA",
  Hawaii:"HI", Idaho:"ID", Illinois:"IL", Indiana:"IN", Iowa:"IA", Kansas:"KS",
  Kentucky:"KY", Louisiana:"LA", Maine:"ME", Maryland:"MD", Massachusetts:"MA",
  Michigan:"MI", Minnesota:"MN", Mississippi:"MS", Missouri:"MO", Montana:"MT",
  Nebraska:"NE", Nevada:"NV", "New Hampshire":"NH", "New Jersey":"NJ",
  "New Mexico":"NM", "New York":"NY", "North Carolina":"NC", "North Dakota":"ND",
  Ohio:"OH", Oklahoma:"OK", Oregon:"OR", Pennsylvania:"PA", "Rhode Island":"RI",
  "South Carolina":"SC", "South Dakota":"SD", Tennessee:"TN", Texas:"TX",
  Utah:"UT", Vermont:"VT", Virginia:"VA", Washington:"WA",
  "West Virginia":"WV", Wisconsin:"WI", Wyoming:"WY"
};

function placeLabel(r) {
  // Two-letter state suffix for US (your ‚Äúsuffix‚Äù requirement)
  if (r.country === "United States" && r.admin1 && US_STATES[r.admin1]) {
    return `${r.name}, ${US_STATES[r.admin1]}`;
  }
  // fallback: City, admin1
  if (r.admin1) return `${r.name}, ${r.admin1}`;
  return r.name;
}

/* ========= View toggles ========= */
function showChart() { mainView.style.display = "none"; chartView.style.display = "block"; }
function showMain()  { chartView.style.display = "none"; mainView.style.display = "block"; }

/* ========= Geocode ========= */
async function geocode(name) {
  const r = await fetch(
    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`
  );
  const j = await r.json();
  if (!j.results?.length) throw new Error(`Location not found: ${name}`);
  return j.results[0];
}

/* ========= Timezone-correct "today" (YYYY-MM-DD) ========= */
function todayInTimeZone(tz) {
  // en-CA gives YYYY-MM-DD
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: tz,
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  }).format(new Date());
}

/* ========= Forecast + date correction (start TODAY) ========= */
async function get7DayFromToday(lat, lon) {
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
    `&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto`;
  const r = await fetch(url);
  const j = await r.json();

  const tz = j.timezone || "UTC";
  const today = todayInTimeZone(tz);

  const days = [];
  const hi = [];
  const lo = [];

  const t = j.daily.time;
  const h = j.daily.temperature_2m_max;
  const l = j.daily.temperature_2m_min;

  for (let i = 0; i < t.length; i++) {
    if (t[i] >= today) {
      days.push(t[i]);
      hi.push(Math.round(h[i]));
      lo.push(Math.round(l[i]));
    }
    if (days.length === 7) break;
  }

  // fallback if something weird happens
  if (days.length < 7) {
    for (let i = 0; i < t.length && days.length < 7; i++) {
      if (!days.includes(t[i])) {
        days.push(t[i]);
        hi.push(Math.round(h[i]));
        lo.push(Math.round(l[i]));
      }
    }
  }

  return { days, hi, lo, tz };
}

/* ========= Align B to A's day labels (so one chart) ========= */
function alignToDays(days, data) {
  const mapHi = new Map(data.days.map((d, i) => [d, data.hi[i]]));
  const mapLo = new Map(data.days.map((d, i) => [d, data.lo[i]]));
  return {
    hi: days.map(d => mapHi.has(d) ? mapHi.get(d) : null),
    lo: days.map(d => mapLo.has(d) ? mapLo.get(d) : null)
  };
}

/* ========= HTML legend plugin (dotted lows) ========= */
const htmlLegendPlugin = {
  id: "htmlLegend",
  afterUpdate(chart, args, opts) {
    const el = document.getElementById(opts.containerID);
    el.innerHTML = "";

    chart.data.datasets.forEach((ds, i) => {
      const row = document.createElement("div");
      row.className = "legend-item";

      const line = document.createElement("div");
      line.className = "legend-line";
      line.style.borderTopColor = ds.borderColor;
      line.style.color = ds.borderColor;

      // DOTTED legend sample for lows (datasets with borderDash)
      if (Array.isArray(ds.borderDash) && ds.borderDash.length) {
        line.style.borderTopStyle = "dotted";
      } else {
        line.style.borderTopStyle = "solid";
      }

      const dot = document.createElement("div");
      dot.className = "legend-dot";
      if (ds.pointStyle === "rectRot") dot.classList.add("diamond");
      line.appendChild(dot);

      const text = document.createElement("span");
      text.textContent = ds.label;

      row.onclick = () => {
        chart.toggleDataVisibility(i);
        chart.update();
      };

      row.appendChild(line);
      row.appendChild(text);
      el.appendChild(row);
    });
  }
};

let chart;

function renderChart(dayLabels, aLabel, aSeries, bLabel, bSeries) {
  if (chart) chart.destroy();

  const COLOR_A = "#1f77b4";
  const COLOR_B = "#ff7f0e";

  chart = new Chart(comboChart, {
    type: "line",
    data: {
      labels: dayLabels,
      datasets: [
        { label: `${aLabel} High`, data: aSeries.hi, borderColor: COLOR_A, borderWidth: 3, pointRadius: 3 },
        { label: `${aLabel} Low`,  data: aSeries.lo, borderColor: COLOR_A, borderDash: [2,6], borderWidth: 2, pointRadius: 3 },
        { label: `${bLabel} High`, data: bSeries.hi, borderColor: COLOR_B, borderWidth: 3, pointRadius: 3, pointStyle: "rectRot" },
        { label: `${bLabel} Low`,  data: bSeries.lo, borderColor: COLOR_B, borderDash: [2,6], borderWidth: 2, pointRadius: 3, pointStyle: "rectRot" }
      ]
    },
    options: {
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { display: false },
        htmlLegend: { containerID: "htmlLegend" }
      },
      scales: {
        y: { title: { display: true, text: "¬∞F" } }
      }
    },
    plugins: [htmlLegendPlugin]
  });
}

async function compare() {
  status.textContent = "Loading‚Ä¶";
  try {
    const [A, B] = await Promise.all([ geocode(locA.value), geocode(locB.value) ]);

    const ALabel = placeLabel(A);
    const BLabel = placeLabel(B);

    aTitle.textContent = ALabel;
    bTitle.textContent = BLabel;

    // Show confirmation echo with coords too
    aEcho.textContent = `${ALabel} (${A.latitude.toFixed(4)}, ${A.longitude.toFixed(4)})`;
    bEcho.textContent = `${BLabel} (${B.latitude.toFixed(4)}, ${B.longitude.toFixed(4)})`;

    const [aData, bData] = await Promise.all([
      get7DayFromToday(A.latitude, A.longitude),
      get7DayFromToday(B.latitude, B.longitude)
    ]);

    // Use A's day list as the chart axis (simple + consistent)
    const days = aData.days;

    const aSeries = { hi: aData.hi, lo: aData.lo };
    const bSeries = alignToDays(days, bData);

    aToday.textContent = `${aSeries.hi[0]}¬∞ / ${aSeries.lo[0]}¬∞`;
    bToday.textContent = `${bSeries.hi[0] ?? "‚Äî"}¬∞ / ${bSeries.lo[0] ?? "‚Äî"}¬∞`;

    chartTitle.textContent = `${ALabel} vs ${BLabel} ‚Äî 7-Day (starting today)`;

    const labels = days.map(d => {
      // show weekday (in user's device locale; fine for labels)
      const dt = new Date(d + "T12:00:00");
      return dt.toLocaleDateString([], { weekday: "short" });
    });

    renderChart(labels, ALabel, aSeries, BLabel, bSeries);

    status.textContent = "";
  } catch (e) {
    status.textContent = e.message || String(e);
  }
}

compare();
</script>

</body>
</html>
