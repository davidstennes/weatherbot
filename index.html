<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WeatherBot ‚Äî Know the weather before you go</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #f7f7f7; }
  h2 { margin: 0; }
  h3 { margin: 0; }
  .panel, .card, .chartWrap {
    background: #fff; padding: 16px; border-radius: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
  }
  .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 780px) { .row { grid-template-columns: 1fr 1fr auto; align-items: end; } }

  label { font-weight: 650; display:block; margin-bottom: 6px; }
  input {
    width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 1rem;
  }
  button {
    padding: 12px 14px; border-radius: 10px; border: none;
    background: #0077cc; color: #fff; font-weight: 700; cursor: pointer;
  }
  button:hover { opacity: .92; }
  button:disabled { opacity: .55; cursor: not-allowed; }

  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap: 16px; margin-top: 14px; }
  .temp { font-size: 2rem; font-weight: 900; }
  .small { font-size: .9rem; color: #666; line-height: 1.25; margin-top: 6px; }

  .actions { margin-top: 14px; }
  .wideBtn { width: 100%; font-size: 1.1rem; }

  .legend { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
  .legend-item {
    display:flex; align-items:center; gap:10px;
    background:#f4f4f4; padding:6px 10px; border-radius:10px;
    cursor:pointer; user-select:none;
  }
  .legend-line {
    width: 70px;
    height: 0;
    border-top-width: 3px;
    border-top-style: solid;
    position: relative;
  }
  .legend-dot {
    position:absolute; top:-6px; left:50%;
    transform:translateX(-50%);
    width:10px; height:10px;
    background: currentColor;
    border-radius:50%;
  }
  .legend-dot.diamond {
    border-radius: 2px;
    transform: translateX(-50%) rotate(45deg);
  }

  /* --- Header block --- */
  .brand { margin: 0 0 10px 0; }
  .brandTitle { font-size: 1.5rem; font-weight: 900; margin: 0; }
  .brandSub { margin: 4px 0 0 0; font-size: .95rem; color: #444; font-weight: 650; }
  .brandTag { margin: 4px 0 0 0; font-size: .95rem; color: #666; }

  /* --- Chart tabs --- */
  .tabbar { display:flex; flex-wrap: wrap; gap:8px; margin-top: 12px; }
  .tabbtn {
    background:#e9eef6; color:#123; border:1px solid #d6dbe3;
    padding:10px 12px; border-radius:10px; font-weight:800;
  }
  .tabbtn:hover { opacity: 1; filter: brightness(0.98); }
  .tabbtn.active {
    background:#0077cc; color:#fff; border-color:#0077cc;
  }

  /* neutral ‚Äúback‚Äù button */
  .backBtn {
    background:#eef2f7; color:#123; border:1px solid #d6dbe3;
    font-weight: 800;
  }
</style>
</head>

<body>

<div id="mainView">
  <div class="brand">
    <div class="brandTitle">WeatherBot</div>
    <div class="brandSub">Local conditions &amp; short-term outlook</div>
    <div class="brandTag">Know the weather before you go.</div>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <label>Location A</label>
        <input id="locA" value="Flagstaff">
      </div>
      <div>
        <label>Location B</label>
        <input id="locB" value="San Diego">
      </div>
      <div>
        <button id="compareBtn" onclick="compare()">Compare</button>
      </div>
    </div>
    <div id="status" class="small"></div>
  </div>

  <div class="cards">
    <div class="card">
      <h3 id="aTitle">‚Äî</h3>
      <div id="aEcho" class="small">‚Äî</div>
      <div id="aToday" class="temp">‚Äî</div>
    </div>
    <div class="card">
      <h3 id="bTitle">‚Äî</h3>
      <div id="bEcho" class="small">‚Äî</div>
      <div id="bToday" class="temp">‚Äî</div>
    </div>
  </div>

  <div class="actions">
    <button class="wideBtn" onclick="showTempChart()">View 7-Day Outlook</button>
  </div>
</div>

<!-- Temperature chart view -->
<div id="chartView" style="display:none;">
  <button class="backBtn" onclick="showMain()">‚Üê Back to Today</button>

  <div class="chartWrap" style="margin-top:12px;">
    <div class="tabbar">
      <button id="tabTemp" class="tabbtn active" onclick="showTempChart()">üå°Ô∏è Temperature</button>
      <button id="tabWind" class="tabbtn" onclick="showWindChart()">üí® Wind</button>
      <button id="tabRain" class="tabbtn" onclick="showRainChart()">üåßÔ∏è Rain</button>
    </div>

    <h3 id="chartTitle" style="margin-top:12px;">‚Äî</h3>
    <canvas id="comboChart" height="260"></canvas>
    <div id="htmlLegend" class="legend"></div>
    <p class="small">Color = location ¬∑ Solid = high ¬∑ Dotted = low</p>
  </div>
</div>

<!-- Wind chart view -->
<div id="windView" style="display:none;">
  <button class="backBtn" onclick="showMain()">‚Üê Back to Today</button>

  <div class="chartWrap" style="margin-top:12px;">
    <div class="tabbar">
      <button id="tabTemp2" class="tabbtn" onclick="showTempChart()">üå°Ô∏è Temperature</button>
      <button id="tabWind2" class="tabbtn active" onclick="showWindChart()">üí® Wind</button>
      <button id="tabRain2" class="tabbtn" onclick="showRainChart()">üåßÔ∏è Rain</button>
    </div>

    <h3 id="windTitle" style="margin-top:12px;">‚Äî</h3>
    <canvas id="windChart" height="260"></canvas>
    <div id="windLegend" class="legend"></div>
    <p class="small">Color = location ¬∑ Solid = peak ¬∑ Dotted = average</p>
  </div>
</div>

<!-- Rain chart view -->
<div id="rainView" style="display:none;">
  <button class="backBtn" onclick="showMain()">‚Üê Back to Today</button>

  <div class="chartWrap" style="margin-top:12px;">
    <div class="tabbar">
      <button id="tabTemp3" class="tabbtn" onclick="showTempChart()">üå°Ô∏è Temperature</button>
      <button id="tabWind3" class="tabbtn" onclick="showWindChart()">üí® Wind</button>
      <button id="tabRain3" class="tabbtn active" onclick="showRainChart()">üåßÔ∏è Rain</button>
    </div>

    <h3 id="rainTitle" style="margin-top:12px;">‚Äî</h3>
    <canvas id="rainChart" height="260"></canvas>
    <div id="rainLegend" class="legend"></div>
    <p class="small">Bars = total rain (in) ¬∑ Lines = rain chance (%)</p>
  </div>
</div>

<script>
/* ========= US State full-name -> 2-letter ========= */
const US_STATES = {
  Alabama:"AL", Alaska:"AK", Arizona:"AZ", Arkansas:"AR", California:"CA",
  Colorado:"CO", Connecticut:"CT", Delaware:"DE", Florida:"FL", Georgia:"GA",
  Hawaii:"HI", Idaho:"ID", Illinois:"IL", Indiana:"IN", Iowa:"IA", Kansas:"KS",
  Kentucky:"KY", Louisiana:"LA", Maine:"ME", Maryland:"MD", Massachusetts:"MA",
  Michigan:"MI", Minnesota:"MN", Mississippi:"MS", Missouri:"MO", Montana:"MT",
  Nebraska:"NE", Nevada:"NV", "New Hampshire":"NH", "New Jersey":"NJ",
  "New Mexico":"NM", "New York":"NY", "North Carolina":"NC", "North Dakota":"ND",
  Ohio:"OH", Oklahoma:"OK", Oregon:"OR", Pennsylvania:"PA", "Rhode Island":"RI",
  "South Carolina":"SC", "South Dakota":"SD", Tennessee:"TN", Texas:"TX",
  Utah:"UT", Vermont:"VT", Virginia:"VA", Washington:"WA",
  "West Virginia":"WV", Wisconsin:"WI", Wyoming:"WY"
};

function placeLabel(r) {
  if (r.country === "United States" && r.admin1 && US_STATES[r.admin1]) {
    return `${r.name}, ${US_STATES[r.admin1]}`;
  }
  if (r.admin1) return `${r.name}, ${r.admin1}`;
  return r.name;
}

/* ========= View toggles ========= */
function showMain() {
  chartView.style.display = "none";
  windView.style.display = "none";
  rainView.style.display = "none";
  mainView.style.display = "block";
}

function showTempChart() {
  mainView.style.display = "none";
  windView.style.display = "none";
  rainView.style.display = "none";
  chartView.style.display = "block";
  setTabActive("temp");
}

function showWindChart() {
  mainView.style.display = "none";
  chartView.style.display = "none";
  rainView.style.display = "none";
  windView.style.display = "block";
  setTabActive("wind");
}

function showRainChart() {
  mainView.style.display = "none";
  chartView.style.display = "none";
  windView.style.display = "none";
  rainView.style.display = "block";
  setTabActive("rain");
}

function setTabActive(which) {
  const isTemp = which === "temp";
  const isWind = which === "wind";
  const isRain = which === "rain";

  // chartView tabs
  if (typeof tabTemp !== "undefined") tabTemp.classList.toggle("active", isTemp);
  if (typeof tabWind !== "undefined") tabWind.classList.toggle("active", isWind);
  if (typeof tabRain !== "undefined") tabRain.classList.toggle("active", isRain);

  // windView tabs
  if (typeof tabTemp2 !== "undefined") tabTemp2.classList.toggle("active", isTemp);
  if (typeof tabWind2 !== "undefined") tabWind2.classList.toggle("active", isWind);
  if (typeof tabRain2 !== "undefined") tabRain2.classList.toggle("active", isRain);

  // rainView tabs
  if (typeof tabTemp3 !== "undefined") tabTemp3.classList.toggle("active", isTemp);
  if (typeof tabWind3 !== "undefined") tabWind3.classList.toggle("active", isWind);
  if (typeof tabRain3 !== "undefined") tabRain3.classList.toggle("active", isRain);
}

/* ========= Geocode ========= */
async function geocode(name) {
  const r = await fetch(
    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`
  );
  const j = await r.json();
  if (!j.results?.length) throw new Error(`Location not found: ${name}`);
  return j.results[0];
}

/* ========= Timezone-correct "today" (YYYY-MM-DD) ========= */
function todayInTimeZone(tz) {
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: tz,
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  }).format(new Date());
}

/* ========= Forecast (start TODAY) ========= */
async function get7DayFromToday(lat, lon) {
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
    `&daily=temperature_2m_max,temperature_2m_min,wind_speed_10m_max,wind_speed_10m_mean,precipitation_sum,precipitation_probability_max` +
    `&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto`;

  const r = await fetch(url);
  const j = await r.json();

  const tz = j.timezone || "UTC";
  const today = todayInTimeZone(tz);

  const days = [];
  const hi = [];
  const lo = [];
  const windPeak = [];
  const windAvg = [];
  const rainIn = [];
  const rainProb = [];

  const t  = j.daily.time;
  const h  = j.daily.temperature_2m_max;
  const l  = j.daily.temperature_2m_min;
  const wp = j.daily.wind_speed_10m_max;
  const wa = j.daily.wind_speed_10m_mean;
  const pr = j.daily.precipitation_sum;
  const pp = j.daily.precipitation_probability_max;

  for (let i = 0; i < t.length; i++) {
    if (t[i] >= today) {
      days.push(t[i]);
      hi.push(Math.round(h[i]));
      lo.push(Math.round(l[i]));
      windPeak.push(Math.round(wp[i]));
      windAvg.push(Math.round(wa[i]));
      rainIn.push(pr?.[i] != null ? Math.round(pr[i] * 100) / 100 : null); // keep 2 decimals
      rainProb.push(pp?.[i] != null ? Math.round(pp[i]) : null);
    }
    if (days.length === 7) break;
  }

  if (days.length < 7) {
    for (let i = 0; i < t.length && days.length < 7; i++) {
      if (!days.includes(t[i])) {
        days.push(t[i]);
        hi.push(Math.round(h[i]));
        lo.push(Math.round(l[i]));
        windPeak.push(Math.round(wp[i]));
        windAvg.push(Math.round(wa[i]));
        rainIn.push(pr?.[i] != null ? Math.round(pr[i] * 100) / 100 : null);
        rainProb.push(pp?.[i] != null ? Math.round(pp[i]) : null);
      }
    }
  }

  return { days, hi, lo, windPeak, windAvg, rainIn, rainProb, tz };
}

/* ========= Align B to A's day labels ========= */
function alignToDays(days, data) {
  const mapHi = new Map(data.days.map((d, i) => [d, data.hi[i]]));
  const mapLo = new Map(data.days.map((d, i) => [d, data.lo[i]]));
  return {
    hi: days.map(d => mapHi.has(d) ? mapHi.get(d) : null),
    lo: days.map(d => mapLo.has(d) ? mapLo.get(d) : null)
  };
}

function alignWindToDays(days, data) {
  const mapPeak = new Map(data.days.map((d, i) => [d, data.windPeak[i]]));
  const mapAvg  = new Map(data.days.map((d, i) => [d, data.windAvg[i]]));
  return {
    peak: days.map(d => mapPeak.has(d) ? mapPeak.get(d) : null),
    avg:  days.map(d => mapAvg.has(d)  ? mapAvg.get(d)  : null)
  };
}

function alignRainToDays(days, data) {
  const mapIn   = new Map(data.days.map((d, i) => [d, data.rainIn[i]]));
  const mapProb = new Map(data.days.map((d, i) => [d, data.rainProb[i]]));
  return {
    inches: days.map(d => mapIn.has(d) ? mapIn.get(d) : null),
    prob:   days.map(d => mapProb.has(d) ? mapProb.get(d) : null)
  };
}

/* ========= HTML legend plugin ========= */
const htmlLegendPlugin = {
  id: "htmlLegend",
  afterUpdate(chart, args, opts) {
    const el = document.getElementById(opts.containerID);
    el.innerHTML = "";

    chart.data.datasets.forEach((ds, i) => {
      const row = document.createElement("div");
      row.className = "legend-item";

      const line = document.createElement("div");
      line.className = "legend-line";
      line.style.borderTopColor = ds.borderColor || ds.backgroundColor;
      line.style.color = ds.borderColor || ds.backgroundColor;

      const isDashed = Array.isArray(ds.borderDash) && ds.borderDash.length;
      const isBar = ds.type === "bar";

      line.style.borderTopStyle = (isBar ? "solid" : (isDashed ? "dotted" : "solid"));

      const dot = document.createElement("div");
      dot.className = "legend-dot";
      if (ds.pointStyle === "rectRot") dot.classList.add("diamond");
      if (isBar) dot.style.display = "none";
      line.appendChild(dot);

      const text = document.createElement("span");
      text.textContent = ds.label;

      row.onclick = () => {
        chart.toggleDataVisibility(i);
        chart.update();
      };

      row.appendChild(line);
      row.appendChild(text);
      el.appendChild(row);
    });
  }
};

let tempChart;
let windChartInstance;
let rainChartInstance;

function renderTempChart(dayLabels, aLabel, aSeries, bLabel, bSeries) {
  if (tempChart) tempChart.destroy();

  const COLOR_A = "#1f77b4";
  const COLOR_B = "#ff7f0e";

  tempChart = new Chart(comboChart, {
    type: "line",
    data: {
      labels: dayLabels,
      datasets: [
        { label: `${aLabel} High`, data: aSeries.hi, borderColor: COLOR_A, borderWidth: 3, pointRadius: 3 },
        { label: `${aLabel} Low`,  data: aSeries.lo, borderColor: COLOR_A, borderDash: [2,6], borderWidth: 2, pointRadius: 3 },
        { label: `${bLabel} High`, data: bSeries.hi, borderColor: COLOR_B, borderWidth: 3, pointRadius: 3, pointStyle: "rectRot" },
        { label: `${bLabel} Low`,  data: bSeries.lo, borderColor: COLOR_B, borderDash: [2,6], borderWidth: 2, pointRadius: 3, pointStyle: "rectRot" }
      ]
    },
    options: {
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: false }, htmlLegend: { containerID: "htmlLegend" } },
      scales: { y: { title: { display: true, text: "¬∞F" } } }
    },
    plugins: [htmlLegendPlugin]
  });
}

function renderWindChart(dayLabels, aLabel, aWind, bLabel, bWind) {
  if (windChartInstance) windChartInstance.destroy();

  const COLOR_A = "#1f77b4";
  const COLOR_B = "#ff7f0e";

  windChartInstance = new Chart(windChart, {
    type: "line",
    data: {
      labels: dayLabels,
      datasets: [
        { label: `${aLabel} Peak`, data: aWind.peak, borderColor: COLOR_A, borderWidth: 3, pointRadius: 3 },
        { label: `${aLabel} Avg`,  data: aWind.avg,  borderColor: COLOR_A, borderDash: [2,6], borderWidth: 2, pointRadius: 3 },
        { label: `${bLabel} Peak`, data: bWind.peak, borderColor: COLOR_B, borderWidth: 3, pointRadius: 3, pointStyle: "rectRot" },
        { label: `${bLabel} Avg`,  data: bWind.avg,  borderColor: COLOR_B, borderDash: [2,6], borderWidth: 2, pointRadius: 3, pointStyle: "rectRot" }
      ]
    },
    options: {
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: false }, htmlLegend: { containerID: "windLegend" } },
      scales: { y: { title: { display: true, text: "mph" } } }
    },
    plugins: [htmlLegendPlugin]
  });
}

function renderRainChart(dayLabels, aLabel, aRain, bLabel, bRain) {
  if (rainChartInstance) rainChartInstance.destroy();

  const COLOR_A = "#1f77b4";
  const COLOR_B = "#ff7f0e";

  rainChartInstance = new Chart(rainChart, {
    data: {
      labels: dayLabels,
      datasets: [
        // Bars: inches
        { type: "bar", label: `${aLabel} Rain (in)`, data: aRain.inches, backgroundColor: COLOR_A, yAxisID: "y" },
        { type: "bar", label: `${bLabel} Rain (in)`, data: bRain.inches, backgroundColor: COLOR_B, yAxisID: "y" },

        // Lines: probability
        { type: "line", label: `${aLabel} Chance (%)`, data: aRain.prob, borderColor: COLOR_A, borderDash: [2,6], borderWidth: 2, pointRadius: 3, yAxisID: "y1" },
        { type: "line", label: `${bLabel} Chance (%)`, data: bRain.prob, borderColor: COLOR_B, borderDash: [2,6], borderWidth: 2, pointRadius: 3, pointRadius: 3, pointStyle: "rectRot", yAxisID: "y1" }
      ]
    },
    options: {
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: false }, htmlLegend: { containerID: "rainLegend" } },
      scales: {
        y:  { title: { display: true, text: "inches" }, beginAtZero: true },
        y1: { title: { display: true, text: "%" }, beginAtZero: true, max: 100, position: "right", grid: { drawOnChartArea: false } }
      }
    },
    plugins: [htmlLegendPlugin]
  });
}

async function compare() {
  status.textContent = "Loading‚Ä¶";
  compareBtn.disabled = true;

  try {
    const [A, B] = await Promise.all([ geocode(locA.value), geocode(locB.value) ]);

    const ALabel = placeLabel(A);
    const BLabel = placeLabel(B);

    aTitle.textContent = ALabel;
    bTitle.textContent = BLabel;

    aEcho.textContent = `${ALabel} (${A.latitude.toFixed(4)}, ${A.longitude.toFixed(4)})`;
    bEcho.textContent = `${BLabel} (${B.latitude.toFixed(4)}, ${B.longitude.toFixed(4)})`;

    const [aData, bData] = await Promise.all([
      get7DayFromToday(A.latitude, A.longitude),
      get7DayFromToday(B.latitude, B.longitude)
    ]);

    const days = aData.days;

    // Temps
    const aTemp = { hi: aData.hi, lo: aData.lo };
    const bTemp = alignToDays(days, bData);

    aToday.textContent = `${aTemp.hi[0]}¬∞ / ${aTemp.lo[0]}¬∞`;
    bToday.textContent = `${bTemp.hi[0] ?? "‚Äî"}¬∞ / ${bTemp.lo[0] ?? "‚Äî"}¬∞`;

    const labels = days.map(d => {
      const dt = new Date(d + "T12:00:00");
      return dt.toLocaleDateString([], { weekday: "short" });
    });

    chartTitle.textContent = `${ALabel} vs ${BLabel} ‚Äî 7-Day (starting today)`;
    renderTempChart(labels, ALabel, aTemp, BLabel, bTemp);

    // Wind
    const aWind = { peak: aData.windPeak, avg: aData.windAvg };
    const bWind = alignWindToDays(days, bData);
    windTitle.textContent = `${ALabel} vs ${BLabel} ‚Äî Wind (7-Day, starting today)`;
    renderWindChart(labels, ALabel, aWind, BLabel, bWind);

    // Rain
    const aRain = { inches: aData.rainIn, prob: aData.rainProb };
    const bRain = alignRainToDays(days, bData);
    rainTitle.textContent = `${ALabel} vs ${BLabel} ‚Äî Rain (7-Day, starting today)`;
    renderRainChart(labels, ALabel, aRain, BLabel, bRain);

    status.textContent = "";
  } catch (e) {
    status.textContent = e?.message || String(e);
  } finally {
    compareBtn.disabled = false;
  }
}

compare();
</script>

</body>
</html>
