<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>Follow the Weather</title>

<meta name="description" content="Compare today‚Äôs weather or the next 7 days between where you are and where you‚Äôre going." />
<link rel="canonical" href="https://davidstennes.github.io/weatherbot/" />

<!-- Open Graph -->
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Follow the Weather" />
<meta property="og:title" content="Follow the Weather" />
<meta property="og:description" content="Compare today‚Äôs weather or the next 7 days for two locations." />
<meta property="og:url" content="https://davidstennes.github.io/weatherbot/" />

<!-- Twitter/X -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Follow the Weather" />
<meta name="twitter:description" content="Compare today‚Äôs weather or the next 7 days for two locations." />

<!-- Step 4: keep GA4 OFF for stability (add back later) -->

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: system-ui, sans-serif; margin: 0; padding: 16px; background: #f7f7f7; }
  h2,h3 { margin: 0; }

  .panel, .card, .chartWrap {
    background: #fff; padding: 16px; border-radius: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
  }

  .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
  @media (min-width: 780px) { .row { grid-template-columns: 1fr 1fr auto; align-items: start; } }

  input {
    width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 1rem;
  }
  input::placeholder { color: #8a8a8a; font-weight: 600; }

  button {
    padding: 12px 14px; border-radius: 10px; border: none;
    background: #0077cc; color: #fff; font-weight: 900; cursor: pointer;
  }
  button:hover { opacity: .92; }
  button:disabled { opacity: .55; cursor: not-allowed; }

  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap: 16px; margin-top: 14px; }
  .temp { font-size: 1.45rem; font-weight: 950; }
  .small { font-size: .9rem; color: #666; line-height: 1.25; margin-top: 6px; }

  .legend { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
  .legend-item {
    display:flex; align-items:center; gap:10px;
    background:#f4f4f4; padding:6px 10px; border-radius:10px;
    cursor:pointer; user-select:none;
  }
  .legend-line {
    width: 70px;
    height: 0;
    border-top-width: 3px;
    border-top-style: solid;
    position: relative;
  }
  .legend-dot {
    position:absolute; top:-6px; left:50%;
    transform:translateX(-50%);
    width:10px; height:10px;
    background: currentColor;
    border-radius:50%;
  }
  .legend-dot.diamond {
    border-radius: 2px;
    transform: translateX(-50%) rotate(45deg);
  }

  /* One heading only */
  .brandTitle { font-size: 1.75rem; font-weight: 1000; margin: 0 0 12px 0; }

  /* Leaving from / Destination inline label + input */
  .fieldRow { display:flex; align-items:center; gap:10px; }
  .fieldLabelInline {
    font-size:.92rem; font-weight:950; color:#333;
    white-space:nowrap; min-width:110px;
  }
  @media (max-width: 420px) { .fieldLabelInline { min-width: 108px; } }

  /* Maps link (same tab, no popup) */
  .mapsLink {
    display:none;
    margin-top:10px;
    font-weight:900;
    color:#0077cc;
    text-decoration:none;
  }
  .mapsLink:hover { text-decoration:underline; }

  /* Tabs */
  .tabbar { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
  .tabbtn {
    background:#e9eef6; color:#123; border:1px solid #d6dbe3;
    padding:10px 12px; border-radius:10px; font-weight:900;
    cursor: pointer;
  }
  .tabbtn.active { background:#0077cc; color:#fff; border-color:#0077cc; }

  /* Back button */
  .backBtn {
    background:#eef2f7; color:#123; border:1px solid #d6dbe3;
    font-weight:900;
  }

  /* Demo styling */
  .demo { color:#8f8f8f; font-style: italic; }

  /* Destination header row + 2-line action box */
  .cityHeaderRow{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }

  .cityActionBox{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #d6dbe3;
    background:#eef2f7;
    cursor:pointer;
    font-weight:900;
    line-height:1.1;
    color:#123;
  }
  .cityActionBox:hover{ filter:brightness(0.98); }
  .actionMain{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:.95rem;
  }
  .actionIcon{ font-size:1rem; line-height:1; }
  .actionSub{
    font-size:.8rem;
    font-weight:750;
    color:#666;
  }

  /* Coming soon panel */
  .soonPanel {
    display:none;
    margin-top:12px;
    background:#fff;
    border-radius:14px;
    padding:14px 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
  }
  .soonHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .soonTitle{ font-weight:950; margin:0; }
  .soonClose{
    background:#eef2f7; color:#123; border:1px solid #d6dbe3;
    border-radius:10px;
    padding:8px 10px;
    font-weight:900;
    cursor:pointer;
  }
  .soonList{ margin:10px 0 0 18px; color:#444; }

  /* ===============================
     Page 1 Sunburst Action Buttons
     =============================== */
  .btnStack{
    display:grid;
    gap:10px;
  }
  @media (min-width: 780px){
    .btnStack{ min-width: 240px; }
  }

  .sunburstBtn{
    --ring: 0.22em;
    position: relative;
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 1000;
    letter-spacing: .2px;

    color: #08324f;
    background: radial-gradient(circle at 35% 30%, #fff3c4, #ffffff 58%);
    box-shadow: 0 2px 8px rgba(0,0,0,.10);
    overflow: hidden;
  }

  .sunburstBtn::before{
    content:"";
    position:absolute;
    inset: calc(-1 * var(--ring));
    border-radius: 14px;
    background: conic-gradient(
      from 0deg,
      rgba(255,180,0,.95),
      rgba(255,215,120,.95),
      rgba(255,180,0,.95),
      rgba(255,235,185,.95),
      rgba(255,180,0,.95)
    );
    z-index: -2;
    filter: blur(.2px);
  }

  .sunburstBtn::after{
    content:"";
    position:absolute;
    inset:0;
    border-radius: 12px;
    background:
      radial-gradient(circle at 35% 30%, rgba(255,255,255,.95), rgba(255,255,255,.15) 58%, rgba(255,255,255,0) 70%),
      radial-gradient(circle at 70% 75%, rgba(0,119,204,.10), rgba(0,119,204,0) 60%);
    z-index:-1;
  }

  .sunburstBtn:hover{ filter: brightness(1.01); }
  .sunburstBtn:active{ transform: scale(.99); }

  .sunburstBtn .sbLine1{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    font-size: 1.02rem;
  }
  .sunburstBtn .sbLine2{
    margin-top:4px;
    font-size: .82rem;
    font-weight: 850;
    color: #3c5566;
    text-align:center;
  }
</style>
</head>

<body>

<!-- Build badge (top-right) -->
<div style="position:fixed;top:8px;right:8px;background:#fff;padding:4px 6px;border:1px solid #ccc;border-radius:8px;font:11px system-ui;z-index:99999;">
  build: STEP-4
</div>

<div id="mainView">
  <div class="brandTitle">Follow the Weather</div>

  <div class="panel">
    <div class="row" style="margin-top:10px;">
      <div class="fieldRow">
        <div class="fieldLabelInline">I‚Äôm leaving from</div>
        <input id="locA" placeholder="City, ZIP, or landmark" aria-label="I‚Äôm leaving from" autocomplete="off" spellcheck="false">
      </div>

      <div class="fieldRow">
        <div class="fieldLabelInline">I‚Äôm going to</div>
        <input id="locB" placeholder="City, ZIP, or landmark" aria-label="I‚Äôm going to" autocomplete="off" spellcheck="false">
      </div>

      <!-- Page 1 actions: Today + 7-Day (sunburst) -->
      <div class="btnStack" aria-label="Weather actions">
        <button id="todayBtn" class="sunburstBtn" type="button" onclick="compareAndStayToday()">
          <div class="sbLine1">‚òÄÔ∏è Weather Today</div>
          <div class="sbLine2">Compare today‚Äôs weather</div>
        </button>

        <button id="sevenBtn" class="sunburstBtn" type="button" onclick="compareAndGo7Day()">
          <div class="sbLine1">üìÖ Weather 7-Day</div>
          <div class="sbLine2">Compare the next 7 days</div>
        </button>
      </div>
    </div>

    <a id="mapsLink" class="mapsLink">Open route in Google Maps ‚Üí</a>
    <div id="status" class="small"></div>
  </div>

  <!-- Cards hidden until user presses Weather Today -->
  <div id="cardsWrap" class="cards" style="display:none;">
    <div class="card">
      <h3 id="aTitle" class="demo">‚Äî</h3>
      <div id="aToday" class="temp demo">‚Äî</div>
      <div class="small demo"></div>
    </div>

    <div class="card">
      <div class="cityHeaderRow">
        <h3 id="bTitle" class="demo">‚Äî</h3>

        <button
          id="bGuideBtn"
          class="cityActionBox demo"
          type="button"
          onclick="wbTrackSeeDoClick(); toggleDestinationSoon();"
          aria-label="See and do at destination city"
        >
          <span class="actionMain">
            <span class="actionIcon">üëÄ</span>
            See &amp; do
          </span>
          <span class="actionSub" id="bGuideSub">in ‚Äî</span>
        </button>
      </div>

      <div id="bToday" class="temp demo">‚Äî</div>
      <div class="small demo"></div>
    </div>
  </div>

  <div id="destSoon" class="soonPanel">
    <div class="soonHeader">
      <div>
        <div class="soonTitle">Destination guide ‚Äî Coming soon</div>
        <div id="destSoonCity" class="small">‚Äî</div>
      </div>
      <button class="soonClose" type="button" onclick="closeDestinationSoon()">Close</button>
    </div>

    <ul class="soonList">
      <li>What to pack for the forecast (rain, wind, heat, cold)</li>
      <li>Local services &amp; essentials (groceries, fuel, pharmacy)</li>
      <li>Things to do &amp; quick highlights</li>
      <li>Travel helpers (hotels, transit, rentals)</li>
    </ul>
    <div class="small" style="margin-top:10px;">
      This will become a helpful city panel (no spammy ads).
    </div>
  </div>
</div>

<!-- Temperature chart view -->
<div id="chartView" style="display:none;">
  <button class="backBtn" onclick="showMain()">‚Üê Back</button>

  <div class="chartWrap" style="margin-top:12px;">
    <div class="tabbar">
      <button id="tabTemp" class="tabbtn active" onclick="showTempChart()">üå°Ô∏è Temperature</button>
      <button id="tabWind" class="tabbtn" onclick="showWindChart()">üí® Wind</button>
      <button id="tabPrecip" class="tabbtn" onclick="showPrecipChart()">üåßÔ∏è Precip</button>
    </div>

    <h3 id="chartTitle" style="margin-top:12px;" class="demo">‚Äî</h3>
    <canvas id="comboChart" height="260"></canvas>
    <div id="htmlLegend" class="legend"></div>
    <p class="small">Color = location ¬∑ Solid = high ¬∑ Dotted = low</p>
  </div>
</div>

<!-- Wind chart view -->
<div id="windView" style="display:none;">
  <button class="backBtn" onclick="showMain()">‚Üê Back</button>

  <div class="chartWrap" style="margin-top:12px;">
    <div class="tabbar">
      <button id="tabTemp2" class="tabbtn" onclick="showTempChart()">üå°Ô∏è Temperature</button>
      <button id="tabWind2" class="tabbtn active" onclick="showWindChart()">üí® Wind</button>
      <button id="tabPrecip2" class="tabbtn" onclick="showPrecipChart()">üåßÔ∏è Precip</button>
    </div>

    <h3 id="windTitle" style="margin-top:12px;" class="demo">‚Äî</h3>
    <canvas id="windChart" height="260"></canvas>
    <div id="windLegend" class="legend"></div>
    <p class="small">Color = location ¬∑ Solid = peak ¬∑ Dotted = average</p>
  </div>
</div>

<!-- Precip chart view -->
<div id="precipView" style="display:none;">
  <button class="backBtn" onclick="showMain()">‚Üê Back</button>

  <div class="chartWrap" style="margin-top:12px;">
    <div class="tabbar">
      <button id="tabTemp3" class="tabbtn" onclick="showTempChart()">üå°Ô∏è Temperature</button>
      <button id="tabWind3" class="tabbtn" onclick="showWindChart()">üí® Wind</button>
      <button id="tabPrecip3" class="tabbtn active" onclick="showPrecipChart()">üåßÔ∏è Precip</button>
    </div>

    <h3 id="precipTitle" style="margin-top:12px;" class="demo">‚Äî</h3>
    <canvas id="precipChart" height="260"></canvas>
    <div id="precipLegend" class="legend"></div>
    <p class="small">Precip (Rain &amp; Snow) ¬∑ Solid = total precip (in) ¬∑ Dotted = chance (%)</p>
  </div>
</div>

<script>
/* =========================================================
   A/B test scaffolding (gtag not installed in Step 4, so tracking no-ops)
========================================================= */
const WB_AB = {
  testName: "see_do_icon_v1",
  variants: [
    { key: "eye",  icon: "üëÄ" },
    { key: "map",  icon: "üó∫Ô∏è" },
    { key: "star", icon: "‚≠ê" }
  ]
};

function wbGetVariant() {
  const storageKey = `wb_ab_${WB_AB.testName}_variant`;
  let v = localStorage.getItem(storageKey);
  if (!v) {
    const pick = WB_AB.variants[Math.floor(Math.random() * WB_AB.variants.length)];
    v = pick.key;
    localStorage.setItem(storageKey, v);
  }
  return v;
}

function wbVariantIcon(variantKey) {
  const v = WB_AB.variants.find(x => x.key === variantKey);
  return v ? v.icon : WB_AB.variants[0].icon;
}

function wbTrack(eventName, params = {}) {
  if (typeof window.gtag !== "function") return;
  gtag("event", eventName, params);
}

function wbTrackSeeDoClick() {
  const variantKey = wbGetVariant();
  wbTrack("see_do_click", { test_name: WB_AB.testName, variant: variantKey });
}

/* =========================================================
   Daily demo route (same for everyone, changes daily)
========================================================= */
const RECOGNIZABLE_CITIES = [
  "Los Angeles, CA","New York City, NY","Chicago, IL","Miami, FL","Seattle, WA",
  "Denver, CO","Phoenix, AZ","Dallas, TX","San Francisco, CA","Washington, DC",
  "Boston, MA","Atlanta, GA","Las Vegas, NV","San Diego, CA","Portland, OR"
];

function utcDayKey(){ return new Date().toISOString().slice(0, 10); }

function hashStringToInt(s) {
  let h = 2166136261;
  for (let i = 0; i < s.length; i++) {
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0);
}

function pickDailyDemoPairUTC() {
  const key = "weatherbot|" + utcDayKey();
  const h = hashStringToInt(key);
  const n = RECOGNIZABLE_CITIES.length;

  const idxA = h % n;
  const idxB = (idxA + 1 + (Math.floor(h / n) % (n - 1))) % n;
  return [RECOGNIZABLE_CITIES[idxA], RECOGNIZABLE_CITIES[idxB]];
}

let [DEMO_ORIGIN, DEMO_DEST] = pickDailyDemoPairUTC();

/* ========= US State full-name -> 2-letter ========= */
const US_STATES = {
  Alabama:"AL", Alaska:"AK", Arizona:"AZ", Arkansas:"AR", California:"CA",
  Colorado:"CO", Connecticut:"CT", Delaware:"DE", Florida:"FL", Georgia:"GA",
  Hawaii:"HI", Idaho:"ID", Illinois:"IL", Indiana:"IN", Iowa:"IA", Kansas:"KS",
  Kentucky:"KY", Louisiana:"LA", Maine:"ME", Maryland:"MD", Massachusetts:"MA",
  Michigan:"MI", Minnesota:"MN", Mississippi:"MS", Missouri:"MO", Montana:"MT",
  Nebraska:"NE", Nevada:"NV", "New Hampshire":"NH", "New Jersey":"NJ",
  "New Mexico":"NM", "New York":"NY", "North Carolina":"NC", "North Dakota":"ND",
  Ohio:"OH", Oklahoma:"OK", Oregon:"OR", Pennsylvania:"PA", "Rhode Island":"RI",
  "South Carolina":"SC", "South Dakota":"SD", Tennessee:"TN", Texas:"TX",
  Utah:"UT", Vermont:"VT", Virginia:"VA", Washington:"WA",
  "West Virginia":"WV", Wisconsin:"WI", Wyoming:"WY"
};

function placeLabel(r) {
  if (r.country === "United States" && r.admin1 && US_STATES[r.admin1]) {
    return `${r.name}, ${US_STATES[r.admin1]}`;
  }
  if (r.admin1) return `${r.name}, ${r.admin1}`;
  return r.name;
}

/* ========= Weather code -> icon + words ========= */
function wxLabelAndIcon(code){
  if (code == null) return { label: "‚Äî", icon: "‚ùî" };
  if (code === 0) return { label: "Sunny", icon: "‚òÄÔ∏è" };
  if (code === 1) return { label: "Mostly sunny", icon: "üå§Ô∏è" };
  if (code === 2) return { label: "Partly cloudy", icon: "‚õÖ" };
  if (code === 3) return { label: "Cloudy", icon: "‚òÅÔ∏è" };
  if (code === 45 || code === 48) return { label: "Fog", icon: "üå´Ô∏è" };
  if ((code >= 51 && code <= 57) || (code >= 61 && code <= 67) || (code >= 80 && code <= 82))
    return { label: "Rain", icon: "üåßÔ∏è" };
  if (code >= 71 && code <= 77) return { label: "Snow", icon: "‚ùÑÔ∏è" };
  if (code === 95 || code === 96 || code === 99) return { label: "Thunder", icon: "‚õàÔ∏è" };
  return { label: "Mixed", icon: "üå¶Ô∏è" };
}

/* ========= Destination Coming Soon panel ========= */
function toggleDestinationSoon() {
  const open = destSoon.style.display === "block";
  if (open) { destSoon.style.display = "none"; return; }
  destSoonCity.textContent = `Destination: ${bTitle.textContent || DEMO_DEST}`;
  destSoon.style.display = "block";
  destSoon.scrollIntoView({ behavior: "smooth", block: "nearest" });
}
function closeDestinationSoon(){ destSoon.style.display = "none"; }

/* ========= View toggles ========= */
function showMain() {
  chartView.style.display = "none";
  windView.style.display = "none";
  precipView.style.display = "none";
  mainView.style.display = "block";
}
function showTempChart() {
  mainView.style.display = "none";
  windView.style.display = "none";
  precipView.style.display = "none";
  chartView.style.display = "block";
  setTabActive("temp");
}
function showWindChart() {
  mainView.style.display = "none";
  chartView.style.display = "none";
  precipView.style.display = "none";
  windView.style.display = "block";
  setTabActive("wind");
}
function showPrecipChart() {
  mainView.style.display = "none";
  chartView.style.display = "none";
  windView.style.display = "none";
  precipView.style.display = "block";
  setTabActive("precip");
}

function setTabActive(which) {
  const isTemp = which === "temp";
  const isWind = which === "wind";
  const isPrecip = which === "precip";

  tabTemp.classList.toggle("active", isTemp);
  tabWind.classList.toggle("active", isWind);
  tabPrecip.classList.toggle("active", isPrecip);

  tabTemp2.classList.toggle("active", isTemp);
  tabWind2.classList.toggle("active", isWind);
  tabPrecip2.classList.toggle("active", isPrecip);

  tabTemp3.classList.toggle("active", isTemp);
  tabWind3.classList.toggle("active", isWind);
  tabPrecip3.classList.toggle("active", isPrecip);
}

/* ========= Maps link (same tab, no popup) ========= */
function buildGoogleMapsDirLink(originText, destText) {
  const origin = encodeURIComponent(originText.trim());
  const dest = encodeURIComponent(destText.trim());
  return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}`;
}

function updateMapsLink() {
  const a = (locA.value || "").trim();
  const b = (locB.value || "").trim();
  if (!a || !b) {
    mapsLink.style.display = "none";
    mapsLink.removeAttribute("href");
    return;
  }
  mapsLink.href = buildGoogleMapsDirLink(a, b);
  mapsLink.style.display = "inline-block";
}

/* ========= Geocode ========= */
async function geocode(name) {
  const r = await fetch(
    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`
  );
  const j = await r.json();
  if (!j.results?.length) throw new Error(`Location not found: ${name}`);
  return j.results[0];
}

/* ========= Timezone-correct "today" (YYYY-MM-DD) ========= */
function todayInTimeZone(tz) {
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: tz, year: "numeric", month: "2-digit", day: "2-digit"
  }).format(new Date());
}

/* ========= Forecast (start TODAY) ========= */
async function get7DayFromToday(lat, lon) {
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
    `&daily=weathercode,temperature_2m_max,temperature_2m_min,wind_speed_10m_max,wind_speed_10m_mean,precipitation_sum,precipitation_probability_max` +
    `&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto`;

  const r = await fetch(url);
  const j = await r.json();

  const tz = j.timezone || "UTC";
  const today = todayInTimeZone(tz);

  const days = [], hi = [], lo = [], windPeak = [], windAvg = [], precipIn = [], precipProb = [], wxCode = [];

  const t  = j.daily.time;
  const h  = j.daily.temperature_2m_max;
  const l  = j.daily.temperature_2m_min;
  const wp = j.daily.wind_speed_10m_max;
  const wa = j.daily.wind_speed_10m_mean;
  const pr = j.daily.precipitation_sum;
  const pp = j.daily.precipitation_probability_max;
  const wc = j.daily.weathercode;

  for (let i = 0; i < t.length; i++) {
    if (t[i] >= today) {
      days.push(t[i]);
      hi.push(Math.round(h[i]));
      lo.push(Math.round(l[i]));
      windPeak.push(Math.round(wp[i]));
      windAvg.push(Math.round(wa[i]));
      precipIn.push(pr?.[i] != null ? Math.round(pr[i] * 100) / 100 : null);
      precipProb.push(pp?.[i] != null ? Math.round(pp[i]) : null);
      wxCode.push(wc?.[i] ?? null);
    }
    if (days.length === 7) break;
  }

  if (days.length < 7) {
    for (let i = 0; i < t.length && days.length < 7; i++) {
      if (!days.includes(t[i])) {
        days.push(t[i]);
        hi.push(Math.round(h[i]));
        lo.push(Math.round(l[i]));
        windPeak.push(Math.round(wp[i]));
        windAvg.push(Math.round(wa[i]));
        precipIn.push(pr?.[i] != null ? Math.round(pr[i] * 100) / 100 : null);
        precipProb.push(pp?.[i] != null ? Math.round(pp[i]) : null);
        wxCode.push(wc?.[i] ?? null);
      }
    }
  }
  return { days, hi, lo, windPeak, windAvg, precipIn, precipProb, wxCode, tz };
}

/* ========= Align B to A's day labels ========= */
function alignToDays(days, data) {
  const mapHi = new Map(data.days.map((d, i) => [d, data.hi[i]]));
  const mapLo = new Map(data.days.map((d, i) => [d, data.lo[i]]));
  return { hi: days.map(d => mapHi.get(d) ?? null), lo: days.map(d => mapLo.get(d) ?? null) };
}
function alignWindToDays(days, data) {
  const mapPeak = new Map(data.days.map((d, i) => [d, data.windPeak[i]]));
  const mapAvg  = new Map(data.days.map((d, i) => [d, data.windAvg[i]]));
  return { peak: days.map(d => mapPeak.get(d) ?? null), avg: days.map(d => mapAvg.get(d) ?? null) };
}
function alignPrecipToDays(days, data) {
  const mapIn   = new Map(data.days.map((d, i) => [d, data.precipIn[i]]));
  const mapProb = new Map(data.days.map((d, i) => [d, data.precipProb[i]]));
  return { inches: days.map(d => mapIn.get(d) ?? null), prob: days.map(d => mapProb.get(d) ?? null) };
}

/* ========= HTML legend plugin ========= */
const htmlLegendPlugin = {
  id: "htmlLegend",
  afterUpdate(chart, args, opts) {
    const el = document.getElementById(opts.containerID);
    el.innerHTML = "";
    chart.data.datasets.forEach((ds, i) => {
      const row = document.createElement("div");
      row.className = "legend-item";

      const line = document.createElement("div");
      line.className = "legend-line";
      line.style.borderTopColor = ds.borderColor;
      line.style.color = ds.borderColor;

      const isDashed = Array.isArray(ds.borderDash) && ds.borderDash.length;
      line.style.borderTopStyle = isDashed ? "dotted" : "solid";

      const dot = document.createElement("div");
      dot.className = "legend-dot";
      if (ds.pointStyle === "rectRot") dot.classList.add("diamond");
      line.appendChild(dot);

      const text = document.createElement("span");
      text.textContent = ds.label;

      row.onclick = () => { chart.toggleDataVisibility(i); chart.update(); };

      row.appendChild(line);
      row.appendChild(text);
      el.appendChild(row);
    });
  }
};

let tempChart, windChartInstance, precipChartInstance;

const CURRENT = { aLo:null, bLo:null, aPIn:null, bPIn:null, snowAAny:false, snowBAny:false };
const AXIS_TITLE_FONT = { size: 16, weight: "900" };
const AXIS_TITLE_COLOR = "#111";

/* ========= Chart renderers ========= */
function renderTempChart(dayLabels, aLabel, aSeries, bLabel, bSeries) {
  if (tempChart) tempChart.destroy();
  const COLOR_A = "#1f77b4";
  const COLOR_B = "#ff7f0e";

  tempChart = new Chart(comboChart, {
    type: "line",
    data: {
      labels: dayLabels,
      datasets: [
        { label: `${aLabel} High`, data: aSeries.hi, borderColor: COLOR_A, borderWidth: 3, pointRadius: 3 },
        { label: `${aLabel} Low`,  data: aSeries.lo, borderColor: COLOR_A, borderDash: [2,6], borderWidth: 2, pointRadius: 3 },
        { label: `${bLabel} High`, data: bSeries.hi, borderColor: COLOR_B, borderWidth: 3, pointRadius: 3, pointStyle: "rectRot" },
        { label: `${bLabel} Low`,  data: bSeries.lo, borderColor: COLOR_B, borderDash: [2,6], borderWidth: 2, pointRadius: 3, pointStyle: "rectRot" }
      ]
    },
    options: {
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: false }, htmlLegend: { containerID: "htmlLegend" } },
      scales: { y: { title: { display:true, text:"¬∞F", color:AXIS_TITLE_COLOR, font:AXIS_TITLE_FONT } } }
    },
    plugins: [htmlLegendPlugin]
  });
}

function renderWindChart(dayLabels, aLabel, aWind, bLabel, bWind) {
  if (windChartInstance) windChartInstance.destroy();
  const COLOR_A = "#1f77b4";
  const COLOR_B = "#ff7f0e";

  windChartInstance = new Chart(windChart, {
    type: "line",
    data: {
      labels: dayLabels,
      datasets: [
        { label: `${aLabel} Peak`, data: aWind.peak, borderColor: COLOR_A, borderWidth: 3, pointRadius: 3 },
        { label: `${aLabel} Avg`,  data: aWind.avg,  borderColor: COLOR_A, borderDash: [2,6], borderWidth: 2, pointRadius: 3 },
        { label: `${bLabel} Peak`, data: bWind.peak, borderColor: COLOR_B, borderWidth: 3, pointRadius: 3, pointStyle: "rectRot" },
        { label: `${bLabel} Avg`,  data: bWind.avg,  borderColor: COLOR_B, borderDash: [2,6], borderWidth: 2, pointRadius: 3, pointStyle: "rectRot" }
      ]
    },
    options: {
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: false }, htmlLegend: { containerID: "windLegend" } },
      scales: { y: { title: { display:true, text:"MPH", color:AXIS_TITLE_COLOR, font:AXIS_TITLE_FONT } } }
    },
    plugins: [htmlLegendPlugin]
  });
}

function renderPrecipChart(dayLabels, aLabel, aP, bLabel, bP) {
  if (precipChartInstance) precipChartInstance.destroy();
  const COLOR_A = "#1f77b4";
  const COLOR_B = "#ff7f0e";

  const aSnow = CURRENT.snowAAny ? " ‚ùÑÔ∏è" : "";
  const bSnow = CURRENT.snowBAny ? " ‚ùÑÔ∏è" : "";

  precipChartInstance = new Chart(precipChart, {
    type: "line",
    data: {
      labels: dayLabels,
      datasets: [
        { label: `${aLabel} Precip (in)${aSnow}`, data: aP.inches, borderColor: COLOR_A, borderWidth: 3, pointRadius: 3, yAxisID: "y" },
        { label: `${aLabel} Chance (%)${aSnow}`, data: aP.prob,   borderColor: COLOR_A, borderDash: [2,6], borderWidth: 2, pointRadius: 3, yAxisID: "y1" },
        { label: `${bLabel} Precip (in)${bSnow}`, data: bP.inches, borderColor: COLOR_B, borderWidth: 3, pointRadius: 3, pointStyle: "rectRot", yAxisID: "y" },
        { label: `${bLabel} Chance (%)${bSnow}`, data: bP.prob,   borderColor: COLOR_B, borderDash: [2,6], borderWidth: 2, pointRadius: 3, pointStyle: "rectRot", yAxisID: "y1" }
      ]
    },
    options: {
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: false }, htmlLegend: { containerID: "precipLegend" } },
      scales: {
        y:  { title: { display:true, text:"INCHES", color:AXIS_TITLE_COLOR, font:AXIS_TITLE_FONT }, beginAtZero:true },
        y1: { title: { display:true, text:"%", color:AXIS_TITLE_COLOR, font:AXIS_TITLE_FONT }, beginAtZero:true, max:100, position:"right", grid:{ drawOnChartArea:false } }
      }
    },
    plugins: [htmlLegendPlugin]
  });
}

/* ========= Demo render ========= */
function updateGuideButtonCity() {
  const city = (bTitle.textContent || "").split(",")[0].trim();
  bGuideSub.textContent = city ? `in ${city}` : "in destination";
}

function renderDemoImmediately() {
  aTitle.textContent = DEMO_ORIGIN;
  bTitle.textContent = DEMO_DEST;
  updateGuideButtonCity();

  // Cards are hidden until Today is pressed; keep safe demo values anyway.
  aToday.textContent = "‚õÖ Partly cloudy ¬∑ ‚Äî";
  bToday.textContent = "‚òÄÔ∏è Sunny ¬∑ ‚Äî";

  chartTitle.textContent  = `${DEMO_ORIGIN} vs ${DEMO_DEST} ‚Äî 7-Day (starting today)`;
  windTitle.textContent   = `${DEMO_ORIGIN} vs ${DEMO_DEST} ‚Äî Wind (7-Day, starting today)`;
  precipTitle.textContent = `${DEMO_ORIGIN} vs ${DEMO_DEST} ‚Äî Precip (7-Day, starting today)`;

  const demoLabels = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  const demoTempA = { hi:[74,76,77,75,73,72,71], lo:[60,61,62,60,59,58,57] };
  const demoTempB = { hi:[66,67,69,68,66,65,64], lo:[51,52,53,52,51,50,49] };

  const demoWindA = { peak:[16,18,20,21,18,15,13], avg:[8,9,10,11,9,8,7] };
  const demoWindB = { peak:[22,24,25,23,21,20,18], avg:[11,12,13,12,11,10,9] };

  const demoPrecipA = { inches:[0.00,0.05,0.00,0.10,0.00,0.00,0.00], prob:[5,10,5,15,5,3,2] };
  const demoPrecipB = { inches:[0.20,0.30,0.10,0.40,0.25,0.10,0.05], prob:[30,35,25,40,30,20,15] };

  CURRENT.snowAAny = false;
  CURRENT.snowBAny = false;

  renderTempChart(demoLabels, DEMO_ORIGIN, demoTempA, DEMO_DEST, demoTempB);
  renderWindChart(demoLabels, DEMO_ORIGIN, demoWindA, DEMO_DEST, demoWindB);
  renderPrecipChart(demoLabels, DEMO_ORIGIN, demoPrecipA, DEMO_DEST, demoPrecipB);
}

/* ========= Real data load & render ========= */
async function loadAndRenderPair(originText, destText, { demo = false } = {}) {
  const [A, B] = await Promise.all([ geocode(originText), geocode(destText) ]);
  const ALabel = placeLabel(A);
  const BLabel = placeLabel(B);

  aTitle.textContent = ALabel;
  bTitle.textContent = BLabel;
  updateGuideButtonCity();

  const [aData, bData] = await Promise.all([
    get7DayFromToday(A.latitude, A.longitude),
    get7DayFromToday(B.latitude, B.longitude)
  ]);

  const days = aData.days;

  const aTemp = { hi: aData.hi, lo: aData.lo };
  const bTemp = alignToDays(days, bData);

  // Today cards: icon + words + hi/lo
  const aWx = wxLabelAndIcon(aData.wxCode?.[0]);
  const bWx = wxLabelAndIcon(bData.wxCode?.[0]);

  aToday.textContent = `${aWx.icon} ${aWx.label} ¬∑ ${aTemp.hi[0]}¬∞ / ${aTemp.lo[0]}¬∞`;
  bToday.textContent = `${bWx.icon} ${bTemp.hi[0] ?? "‚Äî"}¬∞ / ${bTemp.lo[0] ?? "‚Äî"}¬∞`;

  const labels = days.map(d => new Date(d + "T12:00:00").toLocaleDateString([], { weekday:"short" }));

  chartTitle.textContent = `${ALabel} vs ${BLabel} ‚Äî 7-Day (starting today)`;
  renderTempChart(labels, ALabel, aTemp, BLabel, bTemp);

  const aWind = { peak: aData.windPeak, avg: aData.windAvg };
  const bWind = alignWindToDays(days, bData);
  windTitle.textContent = `${ALabel} vs ${BLabel} ‚Äî Wind (7-Day, starting today)`;
  renderWindChart(labels, ALabel, aWind, BLabel, bWind);

  const aP = { inches: aData.precipIn, prob: aData.precipProb };
  const bP = alignPrecipToDays(days, bData);

  const snowAAny = days.some((_, i) => (aData.lo?.[i] != null && aData.lo[i] <= 32 && (aData.precipIn?.[i] || 0) > 0));
  const bLoAligned = bTemp.lo;
  const snowBAny = days.some((_, i) => (bLoAligned?.[i] != null && bLoAligned[i] <= 32 && (bP.inches?.[i] || 0) > 0));

  CURRENT.aLo = aData.lo;
  CURRENT.bLo = bLoAligned;
  CURRENT.aPIn = aData.precipIn;
  CURRENT.bPIn = bP.inches;
  CURRENT.snowAAny = snowAAny;
  CURRENT.snowBAny = snowBAny;

  precipTitle.textContent = `${ALabel} vs ${BLabel} ‚Äî Precip (7-Day, starting today)`;
  renderPrecipChart(labels, ALabel, aP, BLabel, bP);

  if (!demo) {
    [aTitle, aToday, bTitle, bGuideBtn, bToday, chartTitle, windTitle, precipTitle].forEach(el => el.classList.remove("demo"));
  }

  destSoonCity.textContent = `Destination: ${bTitle.textContent || DEMO_DEST}`;
}

/* ========= NEW: Compare actions for the two Page-1 buttons ========= */
function setBusy(isBusy){
  todayBtn.disabled = isBusy;
  sevenBtn.disabled = isBusy;
}

async function compareCore() {
  const aText = (locA.value || "").trim();
  const bText = (locB.value || "").trim();

  updateMapsLink();

  if (!aText || !bText) {
    status.textContent = "Enter I‚Äôm leaving from and I‚Äôm going to, then choose Weather Today or Weather 7-Day.";
    return false;
  }

  status.textContent = "";
  setBusy(true);

  try {
    await loadAndRenderPair(aText, bText, { demo:false });
    return true;
  } catch (e) {
    status.textContent = e?.message || String(e);
    return false;
  } finally {
    setBusy(false);
  }
}

async function compareAndStayToday() {
  const ok = await compareCore();
  if (!ok) return;

  // show cards ONLY when Today is pressed
  cardsWrap.style.display = "grid";
  showMain(); // stay on main page
}

async function compareAndGo7Day() {
  const ok = await compareCore();
  if (!ok) return;

  // keep cards hidden when user chooses 7-day
  cardsWrap.style.display = "none";
  showTempChart(); // jump straight to graphs
}

/* =========================================================
   STEP 4 STARTUP (ENABLED UI + clicks, NO auto-fetch demo swap)
========================================================= */
updateMapsLink();
renderDemoImmediately();           // safe demo charts + filled UI
cardsWrap.style.display = "none";  // cards hidden until Today press

locA.addEventListener("input", updateMapsLink);
locB.addEventListener("input", updateMapsLink);
</script>

</body>
</html>
