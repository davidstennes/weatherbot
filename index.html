<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WeatherBot</title>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#fff;color:#111;
    }

    /* HERO (squished) */
    .wb-hero{padding:1.05rem 1rem 0.65rem;text-align:center;}
    .wb-hero-row{display:flex;align-items:center;justify-content:center;gap:.65rem;}
    .wb-title{margin:0;font-size:clamp(1.45rem,4.8vw,2.0rem);font-weight:650;line-height:1.12;max-width:22rem;}
    .wb-icon{font-size:1.35rem;opacity:.8;user-select:none;}
    .wb-left{transform:translateY(.07em);} .wb-right{transform:translateY(.03em);}
    .wb-subtitle{margin-top:.35rem;font-size:.92rem;opacity:.72;}

    .status{
      text-align:center;
      margin-top:-0.2rem;
      font-size:0.88rem;
      opacity:0.65;
      min-height:1.1rem;
      padding:0 1rem;
    }

    /* =====================
       FIXED GRID (align columns)
       ===================== */
    :root{
      --cityW: 190px;   /* fixed city column width */
      --dayW: 86px;     /* fixed day column width */
      --gap: 10px;      /* row column gap */
      --rowGap: 14px;   /* vertical spacing between city rows */

      --radius: 18px;
      --border: #e0e0e0;
    }

    .compare{
      width: 100%;
      max-width: calc(var(--cityW) + (3 * var(--dayW)) + (3 * var(--gap)));
      margin: 0 auto;
      padding: 0.65rem 1rem 1.25rem;
      display:flex;
      flex-direction:column;
      gap: var(--rowGap);
    }

    .row{
      display:grid;
      grid-template-columns: var(--cityW) var(--dayW) var(--dayW) var(--dayW);
      gap: var(--gap);
      justify-content:center;
      align-items:start;
    }

    .card{
      border:2px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      color:#555;
    }

    /* CITY CARD (fixed width + squished height) */
    .city-card{
      width: var(--cityW);
      min-height: 86px;
      padding: 0.55rem 0.55rem 0.5rem;
      position:relative;
      justify-content:center;
      gap:0.1rem;
    }

    /* After selection we display city name as big text, and allow tapping to edit */
    .city-display{
      width:100%;
      padding: 0.25rem 0.5rem;
      text-align:left;
      cursor:text;
      user-select:none;
    }

    .city-name{
      font-size: 22px;
      font-weight: 750;
      letter-spacing: -0.01em;
      color:#111;
      line-height: 1.05;
      margin:0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .city-subline{
      font-size: 12px;
      opacity: 0.62;
      margin-top: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Input mode (shown while typing) */
    .city-input{
      width:100%;
      border:0;
      outline:none;
      font-size:16px; /* prevent zoom */
      font-weight:700;
      text-align:left;
      padding: 0.35rem 0.5rem;
      border-radius: 14px;
      background: transparent;
      color:#111;
      display:none; /* default hidden (display mode) */
    }
    .city-input::placeholder{ color:#777; font-weight:700; }

    /* Suggestions dropdown */
    .suggestions{
      position:absolute;
      left:0; right:0;
      top: 100%;
      margin-top: 8px;
      width: 340px;
      max-width: calc(100vw - 2rem);
      border:1px solid #e6e6e6;
      border-radius:14px;
      background:#fff;
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      overflow:hidden;
      display:none;
      z-index:50;
    }
    .suggestions button{
      width:100%;
      border:0;
      background:#fff;
      padding:0.6rem 0.75rem;
      text-align:left;
      font-size:15px;
      color:#111;
    }
    .suggestions button:active{ background:#f5f5f5; }
    .suggestions .sub{ display:block; font-size:12px; opacity:.65; margin-top:2px; }

    /* DAY CARDS (squished height) */
    .day-card{
      width: var(--dayW);
      height: 132px;
      padding: 0.5rem 0.35rem 0.45rem;
      gap: 0.25rem;
      align-items:center;
    }

    .dow{font-weight:700;color:#777;margin-top:0.05rem;font-size: 20px; letter-spacing: -0.01em;}
    .temps{margin-top:0.25rem;display:flex;flex-direction:column;align-items:center;gap:0.2rem;color:#111;}
    .hi{font-size:2.0rem;font-weight:800;line-height:1;}
    .lo{font-size:1.5rem;font-weight:750;opacity:.52;line-height:1;}

    /* slightly tighter on very small screens */
    @media (max-width: 390px){
      :root{ --cityW: 175px; --dayW: 80px; --gap: 8px; --rowGap: 12px; }
      .city-name{ font-size: 20px; }
      .dow{ font-size: 19px; }
      .hi{ font-size: 1.9rem; }
      .lo{ font-size: 1.4rem; }
      .day-card{ height: 126px; }
      .city-card{ min-height: 82px; }
    }
  </style>
</head>

<body>

  <header class="wb-hero">
    <div class="wb-hero-row">
      <span class="wb-icon wb-left" aria-hidden="true">üå¥</span>
      <h1 class="wb-title">Where is the weather better?</h1>
      <span class="wb-icon wb-right" aria-hidden="true">‚õ∑Ô∏è</span>
    </div>
    <div class="wb-subtitle">Compare up to five places side by side.</div>
  </header>

  <div id="status" class="status"></div>

  <main class="compare" id="compare"></main>

  <script>
    const statusEl = document.getElementById("status");
    const compareEl = document.getElementById("compare");
    function setStatus(msg){ statusEl.textContent = msg || ""; }

    function fmtWeekday(dateStr){
      const d = new Date(dateStr + "T12:00:00");
      return new Intl.DateTimeFormat(undefined,{weekday:"short"}).format(d);
    }
    function fmtTemp(n){
      if(n===null||n===undefined||Number.isNaN(n)) return "‚Äî";
      return Math.round(n) + "¬∞";
    }

    async function geocodeCities(query){
      const url = new URL("https://geocoding-api.open-meteo.com/v1/search");
      url.searchParams.set("name", query);
      url.searchParams.set("count", "8");
      url.searchParams.set("language", "en");
      url.searchParams.set("format", "json");
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error("Geocoding failed");
      const data = await res.json();
      return data.results || [];
    }

    async function fetch3DayForecastF(lat, lon){
      const url = new URL("https://api.open-meteo.com/v1/forecast");
      url.searchParams.set("latitude", lat);
      url.searchParams.set("longitude", lon);
      url.searchParams.set("daily", "temperature_2m_max,temperature_2m_min");
      url.searchParams.set("temperature_unit", "fahrenheit");
      url.searchParams.set("timezone", "auto");
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error("Forecast failed");
      return await res.json();
    }

    function formatSubline(city){
      const state = city.admin1 || city.admin2 || city.admin3 || "";
      const country = city.country || "";
      if(state) return `${city.name}, ${state}`;
      if(country) return `${city.name}, ${country}`;
      return city.name;
    }

    function makeRow(index){
      const row = document.createElement("section");
      row.className = "row";
      row.setAttribute("aria-label", `City row ${index+1}`);

      // City card
      const cityCard = document.createElement("div");
      cityCard.className = "card city-card";

      const display = document.createElement("div");
      display.className = "city-display";

      const cityName = document.createElement("div");
      cityName.className = "city-name";
      cityName.textContent = "Add city";

      const citySub = document.createElement("div");
      citySub.className = "city-subline";
      citySub.textContent = "";

      display.appendChild(cityName);
      display.appendChild(citySub);

      const input = document.createElement("input");
      input.className = "city-input";
      input.type = "text";
      input.placeholder = "Add city";
      input.autocomplete = "off";

      const sugg = document.createElement("div");
      sugg.className = "suggestions";
      sugg.setAttribute("role","listbox");

      cityCard.appendChild(display);
      cityCard.appendChild(input);
      cityCard.appendChild(sugg);

      // Day cards x3
      const dayCards = [];
      for(let i=0;i<3;i++){
        const d = document.createElement("div");
        d.className = "card day-card";

        const dow = document.createElement("div");
        dow.className = "dow";
        dow.id = `dow_${index}_${i}`;
        dow.textContent = "‚Äî";

        const temps = document.createElement("div");
        temps.className = "temps";

        const hi = document.createElement("div");
        hi.className = "hi";
        hi.id = `hi_${index}_${i}`;
        hi.textContent = "‚Äî";

        const lo = document.createElement("div");
        lo.className = "lo";
        lo.id = `lo_${index}_${i}`;
        lo.textContent = "‚Äî";

        temps.appendChild(hi);
        temps.appendChild(lo);

        d.appendChild(dow);
        d.appendChild(temps);

        dayCards.push(d);
      }

      // Append to row
      row.appendChild(cityCard);
      dayCards.forEach(c => row.appendChild(c));

      // Init dow labels (today/tomorrow/next)
      const now = new Date();
      for(let i=0;i<3;i++){
        const dt = new Date(now);
        dt.setDate(now.getDate()+i);
        document.addEventListener("DOMContentLoaded", ()=>{});
        const label = new Intl.DateTimeFormat(undefined,{weekday:"short"}).format(dt);
        // set once created
        setTimeout(()=>{ document.getElementById(`dow_${index}_${i}`).textContent = label; }, 0);
      }

      // Autocomplete behavior
      let debounceTimer = null;
      let activeResults = [];
      let lastQuery = "";

      function showSuggestions(show){
        sugg.style.display = show ? "block" : "none";
      }

      function renderSuggestions(results){
        sugg.innerHTML = "";
        if(!results.length){ showSuggestions(false); return; }

        results.slice(0,8).forEach(r=>{
          const btn = document.createElement("button");
          btn.type = "button";
          btn.setAttribute("role","option");

          const primary = `${r.name}${r.admin1 ? ", " + r.admin1 : ""}${r.country ? ", " + r.country : ""}`;
          const secondary = `(${r.latitude.toFixed(3)}, ${r.longitude.toFixed(3)})`;
          btn.innerHTML = `${primary}<span class="sub">${secondary}</span>`;

          btn.addEventListener("click", ()=> selectCity(r));
          sugg.appendChild(btn);
        });

        showSuggestions(true);
      }

      function clearTemps(){
        for(let i=0;i<3;i++){
          document.getElementById(`hi_${index}_${i}`).textContent = "‚Äî";
          document.getElementById(`lo_${index}_${i}`).textContent = "‚Äî";
        }
      }

      async function selectCity(city){
        // display mode values
        cityName.textContent = city.name;
        citySub.textContent = formatSubline(city);

        // exit input mode
        input.style.display = "none";
        display.style.display = "block";

        showSuggestions(false);
        activeResults = [];

        setStatus("Loading forecast‚Ä¶");
        clearTemps();

        try{
          const forecast = await fetch3DayForecastF(city.latitude, city.longitude);
          const daily = forecast.daily;
          if(!daily || !daily.time || daily.time.length < 3) throw new Error("Not enough daily data");

          for(let i=0;i<3;i++){
            document.getElementById(`dow_${index}_${i}`).textContent = fmtWeekday(daily.time[i]);
            document.getElementById(`hi_${index}_${i}`).textContent = fmtTemp(daily.temperature_2m_max[i]);
            document.getElementById(`lo_${index}_${i}`).textContent = fmtTemp(daily.temperature_2m_min[i]);
          }
          setStatus("");
        }catch(e){
          console.error(e);
          setStatus("Couldn‚Äôt load forecast for that city.");
        }
      }

      function enterEditMode(){
        display.style.display = "none";
        input.style.display = "block";
        input.value = "";
        input.focus();
        showSuggestions(false);
      }

      // Tap city card to edit/enter
      display.addEventListener("click", enterEditMode);

      document.addEventListener("click", (e)=>{
        const within = (e.target === input) || sugg.contains(e.target) || display.contains(e.target);
        if(!within) showSuggestions(false);
      });

      input.addEventListener("input", ()=>{
        const q = input.value.trim();
        if(q.length < 2){
          showSuggestions(false);
          setStatus("");
          return;
        }
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async ()=>{
          try{
            lastQuery = q;
            const results = await geocodeCities(q);
            if(input.value.trim() !== lastQuery) return;
            activeResults = results;
            renderSuggestions(results);
          }catch(err){
            console.error(err);
            showSuggestions(false);
            setStatus("Autocomplete unavailable.");
          }
        }, 220);
      });

      input.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" && activeResults.length){
          e.preventDefault();
          selectCity(activeResults[0]);
        }
        if(e.key === "Escape"){
          showSuggestions(false);
          // if they escape without choosing, go back to display
          input.style.display = "none";
          display.style.display = "block";
        }
      });

      // If it's a fresh row, tap "Add city" should open edit mode
      display.style.cursor = "text";

      return row;
    }

    // Build 5 rows
    for(let i=0;i<5;i++){
      compareEl.appendChild(makeRow(i));
    }
  </script>

</body>
</html>
