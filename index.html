<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Follow the weather</title>

<style>
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --text:#111;
  --muted:#6b7280;
  --border:#d1d5db;
  --windBlue:11,60,138; /* base blue (rgb) */
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:20px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

header h1{
  margin:0;
  font-size:26px;
  font-weight:900;
}

main{
  max-width:1100px;
  margin:0 auto;
  padding:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
}

.grid{
  display:grid;
  grid-template-columns:180px repeat(4,1fr);
  gap:10px;
  align-items:center;
}

/* LEFT HEADER */
.cityHeader{
  grid-column:1;
  text-align:center;
  font-weight:900;
  font-size:14px;
}

.cityHeader small{
  display:block;
  font-weight:700;
  color:var(--muted);
}

/* FORECAST TITLE */
.forecastTitle{
  grid-column:2 / -1;
  text-align:center;
  font-weight:900;
  margin-bottom:6px;
}

.day{
  text-align:center;
  font-size:13px;
  font-weight:800;
  color:var(--muted);
}

/* CITY INPUT */
.cityWrap{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.cityInput{
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  font-size:15px;
}

.cityConfirm{
  font-size:12px;
  color:var(--muted);
  min-height:14px;
}

/* FORECAST CELL */
.cell{
  border:1px solid var(--border);
  border-radius:14px;
  min-height:82px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
}

.wxIcon{ font-size:22px; }
.wind{ width:22px; height:22px; display:flex; align-items:center; justify-content:center; }
.hi{ font-weight:900; }
.lo{ font-size:12px; color:var(--muted); }

/* ===== WIND LEGEND ===== */
.legendCard{
  margin-top:14px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
}

.legendTitle{
  margin:0 0 10px 0;
  font-weight:900;
  font-size:14px;
}

.legendRow{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  align-items:flex-end;
}

.legendItem{
  width:64px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}

.legendIcon{
  width:36px;
  height:36px;
}

.legendLabel{
  font-size:11px;
  color:var(--muted);
  text-align:center;
  line-height:1.1;
}
</style>
</head>

<body>

<header>
  <h1>Follow the weather</h1>
</header>

<main>

  <!-- MAIN FORECAST CARD -->
  <div class="card">
    <div class="grid">

      <div class="cityHeader">
        Enter cities
        <small>(up to five)</small>
      </div>

      <div class="forecastTitle">4-day at a glance</div>

      <div></div>
      <div class="day">Thu</div>
      <div class="day">Fri</div>
      <div class="day">Sat</div>
      <div class="day">Sun</div>

      <!-- FIVE CITY ROWS -->
      <template id="rowTemplate">
        <div class="cityWrap">
          <input class="cityInput" list="cities" placeholder="" autocomplete="off" autocapitalize="words" spellcheck="false">
          <div class="cityConfirm"></div>
        </div>
        <div class="cell">‚Äî</div>
        <div class="cell">‚Äî</div>
        <div class="cell">‚Äî</div>
        <div class="cell">‚Äî</div>
      </template>

    </div>
  </div>

  <!-- WIND LEGIBILITY LEGEND -->
  <div class="legendCard">
    <p class="legendTitle">Wind icon legibility (lighter ‚Üí darker)</p>
    <div class="legendRow" id="windLegend"></div>
  </div>

</main>

<datalist id="cities"></datalist>

<script>
const grid = document.querySelector(".grid");
const tpl = document.getElementById("rowTemplate");
const datalist = document.getElementById("cities");

const cToF = c => Math.round(c * 9/5 + 32);

function wxIcon(code){
  if(code === 0) return "‚òÄÔ∏è";
  if(code <= 2) return "üå§Ô∏è";
  if(code === 3) return "‚òÅÔ∏è";
  if(code >= 51 && code <= 67) return "üåßÔ∏è";
  if(code >= 71 && code <= 77) return "üå®Ô∏è";
  if(code >= 95) return "‚õàÔ∏è";
  return "üå°Ô∏è";
}

/* === YOUR CURLY WIND SVG (exact paths), driven by currentColor === */
const windSVG = `
<svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <g fill="currentColor">
    <path d="m174.8,161.7c0,14.5 11.8,26.2 26.2,26.2s26.2-11.8 26.2-26.2-11.8-26.2-26.2-26.2l-191,0"/>
    <path d="m193.6,83c0-14.5 11.8-26.2-26.2-26.2s26.2 11.8 26.2 26.2-11.8 26.2-26.2 26.2l-209.8,0"/>
    <path d="m111.1,180.4c0,10.3 8.4,18.7 18.7,18.7s18.7-8.4 18.7-18.7-8.4-18.7-18.7-18.7l-119.8,0"/>
  </g>
</svg>`;

/* NOTE: Your 2nd path in the snippet you pasted earlier is correct.
   If you see anything weird in that middle curl, paste your exact SVG again and I‚Äôll drop it in verbatim.
*/

function windAlpha(mph){
  const v = Number(mph);
  if(!isFinite(v) || v <= 0) return 0.20;  // faint but visible
  if(v >= 30) return 1.00;                 // max darkness at 30+
  return 0.20 + (v / 30) * 0.80;           // linear
}

function windColorStyle(alpha){
  const a = Math.max(0.2, Math.min(1, alpha));
  const rgb = getComputedStyle(document.documentElement).getPropertyValue("--windBlue").trim() || "11,60,138";
  return `color: rgba(${rgb}, ${a.toFixed(2)})`;
}

function formatPlace(g){
  const parts = [g?.name].filter(Boolean);
  if(g?.admin1) parts.push(g.admin1);
  if(g?.country_code) parts.push(g.country_code);
  return parts.join(", ");
}

async function geocode(q){
  const r = await fetch(
    "https://geocoding-api.open-meteo.com/v1/search?count=5&language=en&name="+encodeURIComponent(q)
  );
  const j = await r.json();
  return j.results || [];
}

async function forecast(lat,lon){
  const r = await fetch(
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
    `&daily=temperature_2m_max,temperature_2m_min,weathercode,wind_speed_10m_max`+
    `&forecast_days=4&timezone=auto&wind_speed_unit=mph`
  );
  return await r.json();
}

/* build 5 rows */
for(let i=1;i<=5;i++){
  const frag = tpl.content.cloneNode(true);
  const input = frag.querySelector(".cityInput");
  const confirm = frag.querySelector(".cityConfirm");
  const cells = frag.querySelectorAll(".cell");

  input.placeholder = `City ${i}${i>2?" (optional)":""}`;

  let debounce;
  let lastQuery = "";
  let lastResults = [];
  let suppressTypeahead = false;

  function clearCells(){
    for(let d=0; d<4; d++) cells[d].textContent = "‚Äî";
  }

  async function resolveAndFetch(cityText){
    const q = (cityText || input.value).trim();
    if(!q) return;

    confirm.textContent = "Searching‚Ä¶";
    clearCells();

    const res = await geocode(q);
    if(!res.length){
      confirm.textContent = "No match found";
      return;
    }
    const g = res[0];

    // Keep input CITY ONLY; show full guess below
    input.value = g.name;
    confirm.textContent = formatPlace(g);

    const wx = await forecast(g.latitude, g.longitude);

    for(let d=0; d<4; d++){
      const hi = wx?.daily?.temperature_2m_max?.[d];
      const lo = wx?.daily?.temperature_2m_min?.[d];
      const wc = wx?.daily?.weathercode?.[d];
      const w  = wx?.daily?.wind_speed_10m_max?.[d];

      const a = windAlpha(w);
      const wTitle = isFinite(w) ? `Max wind ${Math.round(w)} mph` : `Wind data unavailable`;

      cells[d].innerHTML = `
        <div class="wxIcon">${wxIcon(wc)}</div>
        <div class="wind" style="${windColorStyle(a)}" title="${wTitle}">${windSVG}</div>
        <div class="hi">${cToF(hi)}¬∞</div>
        <div class="lo">${cToF(lo)}¬∞</div>
      `;
    }
  }

  // Typeahead + datalist suggestions
  input.addEventListener("keydown",(e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      suppressTypeahead = true;
      setTimeout(()=>{ suppressTypeahead = false; }, 120);
      resolveAndFetch();
    }
    if(e.key === "Backspace" || e.key === "Delete"){
      suppressTypeahead = true;
      setTimeout(()=>{ suppressTypeahead = false; }, 80);
    }
  });

  // Blur is important on Android (it often won‚Äôt fire change reliably)
  input.addEventListener("blur",()=>{
    const q = input.value.trim();
    if(q.length >= 2) resolveAndFetch();
  });

  input.addEventListener("change",()=>{
    // Still keep change for desktop; doesn‚Äôt hurt
    resolveAndFetch();
  });

  input.addEventListener("input",()=>{
    clearTimeout(debounce);

    const typed = input.value.trim();
    if(typed.length < 2){
      datalist.innerHTML = "";
      confirm.textContent = "";
      clearCells();
      return;
    }

    lastQuery = typed;

    debounce = setTimeout(async()=>{
      const now = input.value.trim();
      if(now !== lastQuery || now.length < 2) return;

      const res = await geocode(now);
      lastResults = res;

      // Build datalist (CITY ONLY)
      datalist.innerHTML = "";
      res.forEach(r=>{
        const o = document.createElement("option");
        o.value = r.name;
        datalist.appendChild(o);
      });

      if(res.length){
        const g = res[0];
        confirm.textContent = formatPlace(g);

        // Gentle inline typeahead: fill remainder + highlight it
        const suggestion = g.name || "";
        const tLow = now.toLowerCase();
        const sLow = suggestion.toLowerCase();

        if(!suppressTypeahead &&
           document.activeElement === input &&
           sLow.startsWith(tLow) &&
           suggestion.length > now.length
        ){
          input.value = suggestion;
          input.setSelectionRange(now.length, suggestion.length);
        }

        // If user typed an exact city name that matches the top suggestion,
        // auto-fetch after a short pause (makes row 2 work without extra taps)
        if(suggestion.toLowerCase() === now.toLowerCase()){
          resolveAndFetch(suggestion);
        }
      } else {
        confirm.textContent = "";
      }
    }, 250);
  });

  grid.appendChild(frag);
}

/* ===== RENDER WIND LEGEND ===== */
const legendStops = [
  {label:"Calm",alpha:0.20},
  {label:"Light",alpha:0.35},
  {label:"Breeze",alpha:0.50},
  {label:"Moderate",alpha:0.65},
  {label:"Windy",alpha:0.80},
  {label:"Strong",alpha:1.00},
];

const legend = document.getElementById("windLegend");
legend.innerHTML = legendStops.map(s=>`
  <div class="legendItem">
    <div class="legendIcon" style="color:rgba(11,60,138,${s.alpha})">
      ${windSVG}
    </div>
    <div class="legendLabel">${s.label}</div>
  </div>
`).join("");
</script>

</body>
</html>
