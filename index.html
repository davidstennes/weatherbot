<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Compare</title>

  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#d1d5db;
      --spin:#3b82f6;

      /* Wind icon (data-URI SVG) */
      --wind100: url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20256%20256%27%3E%3Cg%20fill%3D%27none%27%20stroke%3D%27%231e40af%27%20stroke-width%3D%2710%27%20stroke-linecap%3D%27round%27%20stroke-linejoin%3D%27round%27%3E%3Cpath%20d%3D%27m118.2%2C56.9c-3.4%2C1%20-7%2C2.5%20-8.6%2C3.6c-1.2%2C0.8%20-1.2%2C1%201.3%2C4.5c1.4%2C2%202.6%2C3.8%202.7%2C3.8c0.1%2C0.1%202%2C-0.5%204.2%2C-1.4c11.4%2C-4.6%2021.8%2C1.1%2021.9%2C11.9c0%2C5.8%20-4.1%2C11.3%20-10%2C13.8c-1.9%2C0.8%20-8.2%2C0.9%20-46.6%2C0.9l-44.2%2C0l0%2C4.9l0%2C4.9l46%2C-0.1l45.9%2C-0.2l3.7%2C-1.8c4.8%2C-2.3%2010.6%2C-8.2%2013%2C-13c1.6%2C-3.3%201.8%2C-4.2%201.8%2C-9.8c-0.1%2C-5.5%20-0.2%2C-6.5%20-1.8%2C-9.8c-4.1%2C-8.5%20-12.4%2C-13.3%20-22.5%2C-13.2c-2.2%2C0.2%20-5.2%2C0.6%20-6.8%2C1z%27/%3E%3Cpath%20transform%3D%27translate(0%2C-5)%27%20d%3D%27m10%2C137.8l0%2C4.9l105.3%2C0c104.6%2C0%20105.3%2C0%20107.9%2C1.2c3.1%2C1.5%208.2%2C6.8%2010%2C10.3c6.4%2C12.5%201.9%2C26.7%20-10.5%2C33.3c-3.3%2C1.8%20-4.6%2C2.2%20-9.2%2C2.3c-4.8%2C0.2%20-5.7%2C0.1%20-9.1%2C-1.4c-2.2%2C-1%20-4%2C-1.5%20-4.3%2C-1.2c-0.2%2C0.3%20-1.5%2C2%20-2.8%2C3.9c-2.5%2C3.6%20-2.6%2C3.4%201.5%2C5.5c5.9%2C3.1%2014.8%2C4%2021.8%2C2.2c12.9%2C-3.4%2023.2%2C-15.3%2025%2C-28.6c0.6%2C-4.4%200.5%2C-6%20-0.3%2C-10.1c-2.2%2C-10.9%20-9.2%2C-20.7%20-18%2C-25l-4.3%2C-2.1l-106.4%2C0l-106.6%2C-0.1l0%2C4.9z%27/%3E%3Cpath%20d%3D%27m53.7%2C156.9l0%2C4.9l58.7%2C0l58.6%2C0l2%2C1.4c3.1%2C2.1%205.1%2C6.7%205.2%2C11.7c0.1%2C3.6%20-0.1%2C4.3%20-1.8%2C6.3c-3%2C3.6%20-5.5%2C4.7%20-9.8%2C4.4c-2.2%2C-0.2%20-4.7%2C-1%20-6.3%2C-1.8l-2.7%2C-1.5l-3.1%2C3.4c-1.7%2C1.9%20-3.1%2C3.6%20-3.1%2C3.8c0%2C0.2%201.2%2C1.1%202.6%2C2c6.1%2C4%2016%2C5%2022%2C2.2c6.5%2C-3%2011.4%2C-9.8%2012.1%2C-16.6c0.4%2C-3.8%20-1%2C-10.3%20-3%2C-14.3c-1.7%2C-3.3%20-5.7%2C-7.6%20-8.9%2C-9.2l-2.5%2C-1.4l-60.1%2C-0.2l-59.9%2C0l0%2C4.9z%27/%3E%3C/g%3E%3C/svg%3E");
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      padding:18px 14px 14px;
      border-bottom:1px solid var(--border);
      background:var(--bg);
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:center;
    }

    .headWrap{
      width:100%;
      max-width:980px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand .icon{
      font-size:34px;
      line-height:1;
    }
    .brand .icon.van{ transform:scaleX(-1); }

    .titles h1{
      margin:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.15;
    }
    .titles p{
      margin:6px 0 0;
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      line-height:1.25;
    }

    main{
      padding:16px 12px 30px;
      max-width:980px;
      margin:0 auto;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.05);
    }

    .label{
      font-weight:900;
      color:var(--muted);
      font-size:13px;
      margin:0 0 10px;
    }

    /* ===== 4-day grid ===== */
    .grid{
      display:grid;
      /* narrower left column ‚Üí more room for icons/tiles */
      grid-template-columns: 168px repeat(4, 1fr);
      gap:8px;
      align-items:stretch;
    }

    .dayHead{
      text-align:center;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      padding:8px 6px;
      border-radius:12px;
      background:rgba(245,246,248,.75);
      border:1px solid rgba(209,213,219,.55);
    }

    .leftBlank{
      border:none !important;
      background:transparent !important;
      padding:0 !important;
    }

    .rowLeft{
      border:1px solid rgba(209,213,219,.75);
      border-radius:14px;
      background:rgba(249,250,251,.75);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:86px;
    }

    .prompt{
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      margin:0;
      line-height:1.2;
    }

    .cityInput{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:15px;
      font-weight:900;
      outline:none;
    }
    .cityInput::placeholder{ color:rgba(107,114,128,.65); }

    .confirm{
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      line-height:1.2;
      min-height:14px;
    }

    .spinner{
      width:14px;
      height:14px;
      border-radius:50%;
      border:2px solid rgba(59,130,246,.25);
      border-top-color:var(--spin);
      animation:spin .9s linear infinite;
      display:inline-block;
      vertical-align:middle;
      margin-left:6px;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    .addWrap{
      margin-top:2px;
      display:flex;
      justify-content:flex-start;
    }
    .addBtn{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
    }

    .tile{
      border:1px solid rgba(209,213,219,.55);
      border-radius:14px;
      background:rgba(255,255,255,.7);
      padding:10px 6px;
      min-height:86px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
    }

    .tIcon{
      font-size:22px;          /* bigger icon */
      line-height:1;
      position:relative;
      padding-top:18px;        /* space for wind */
    }
    .tIcon::before{
      content:"";
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:0;
      width:18px;
      height:18px;
      background-image:var(--wind100);
      background-repeat:no-repeat;
      background-size:contain;
      opacity:.95;
      pointer-events:none;
    }

    .tHi, .tLo{
      font-size:12px;
      line-height:1.05;
      font-variant-numeric: tabular-nums;
      letter-spacing:.1px;
    }
    .tHi{ font-weight:1000; }
    .tLo{ font-weight:900; color:var(--muted); }

    .hidden{ display:none !important; }

    @media (max-width:520px){
      .grid{ grid-template-columns: 154px repeat(4, 1fr); gap:6px; }
      .cityInput{ font-size:14px; padding:9px 9px; }
      .tile{ padding:9px 6px; }
      .tIcon{ font-size:21px; padding-top:17px; }
      .tIcon::before{ width:17px; height:17px; }
      .dayHead{ font-size:11px; padding:7px 6px; }
    }

    @media (max-width:420px){
      .grid{ grid-template-columns: 146px repeat(4, 1fr); }
      .tHi,.tLo{ font-size:11px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="headWrap">
      <div class="brand">
        <span class="icon van">üöê</span>
        <div class="titles">
          <h1>Weather Compare</h1>
          <p>‚ÄúWhat‚Äôs it like here compared to there?‚Äù</p>
        </div>
      </div>
      <div class="brand" aria-hidden="true">
        <span class="icon">üöô</span>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <p class="label">4-day at a glance (today ‚Üí next 3 days)</p>

      <div class="grid" id="grid">
        <!-- header row -->
        <div class="leftBlank"></div>
        <div class="dayHead" id="day0">‚Äî</div>
        <div class="dayHead" id="day1">‚Äî</div>
        <div class="dayHead" id="day2">‚Äî</div>
        <div class="dayHead" id="day3">‚Äî</div>

        <!-- Row 1 (City 1) -->
        <div class="rowLeft" id="rowLeft1">
          <p class="prompt">City #1</p>
          <input class="cityInput" id="loc1" placeholder="Enter a city‚Ä¶" autocomplete="off" />
          <div class="confirm" id="confirm1"></div>
          <datalist id="list1"></datalist>
        </div>
        <div class="tile"><div class="tIcon" id="r1I0">‚Äî</div><div class="tHi" id="r1H0">‚Äî</div><div class="tLo" id="r1L0">‚Äî</div></div>
        <div class="tile"><div class="tIcon" id="r1I1">‚Äî</div><div class="tHi" id="r1H1">‚Äî</div><div class="tLo" id="r1L1">‚Äî</div></div>
        <div class="tile"><div class="tIcon" id="r1I2">‚Äî</div><div class="tHi" id="r1H2">‚Äî</div><div class="tLo" id="r1L2">‚Äî</div></div>
        <div class="tile"><div class="tIcon" id="r1I3">‚Äî</div><div class="tHi" id="r1H3">‚Äî</div><div class="tLo" id="r1L3">‚Äî</div></div>

        <!-- Row 2 (City 2) + Add City button UNDER this left box -->
        <div class="rowLeft" id="rowLeft2">
          <p class="prompt">City #2</p>
          <input class="cityInput" id="loc2" placeholder="Enter a city‚Ä¶" autocomplete="off" />
          <div class="confirm" id="confirm2"></div>

          <div class="addWrap">
            <button class="addBtn" id="addCityBtn" type="button">+ Add city</button>
          </div>

          <datalist id="list2"></datalist>
        </div>
        <div class="tile"><div class="tIcon" id="r2I0">‚Äî</div><div class="tHi" id="r2H0">‚Äî</div><div class="tLo" id="r2L0">‚Äî</div></div>
        <div class="tile"><div class="tIcon" id="r2I1">‚Äî</div><div class="tHi" id="r2H1">‚Äî</div><div class="tLo" id="r2L1">‚Äî</div></div>
        <div class="tile"><div class="tIcon" id="r2I2">‚Äî</div><div class="tHi" id="r2H2">‚Äî</div><div class="tLo" id="r2L2">‚Äî</div></div>
        <div class="tile"><div class="tIcon" id="r2I3">‚Äî</div><div class="tHi" id="r2H3">‚Äî</div><div class="tLo" id="r2L3">‚Äî</div></div>

        <!-- Row 3 (hidden until + Add city) -->
        <div class="rowLeft hidden" id="rowLeft3">
          <p class="prompt">City #3</p>
          <input class="cityInput" id="loc3" placeholder="Enter a city‚Ä¶" autocomplete="off" />
          <div class="confirm" id="confirm3"></div>
          <datalist id="list3"></datalist>
        </div>
        <div class="tile hidden" id="r3t0"><div class="tIcon" id="r3I0">‚Äî</div><div class="tHi" id="r3H0">‚Äî</div><div class="tLo" id="r3L0">‚Äî</div></div>
        <div class="tile hidden" id="r3t1"><div class="tIcon" id="r3I1">‚Äî</div><div class="tHi" id="r3H1">‚Äî</div><div class="tLo" id="r3L1">‚Äî</div></div>
        <div class="tile hidden" id="r3t2"><div class="tIcon" id="r3I2">‚Äî</div><div class="tHi" id="r3H2">‚Äî</div><div class="tLo" id="r3L2">‚Äî</div></div>
        <div class="tile hidden" id="r3t3"><div class="tIcon" id="r3I3">‚Äî</div><div class="tHi" id="r3H3">‚Äî</div><div class="tLo" id="r3L3">‚Äî</div></div>

        <!-- Row 4 (hidden) -->
        <div class="rowLeft hidden" id="rowLeft4">
          <p class="prompt">City #4</p>
          <input class="cityInput" id="loc4" placeholder="Enter a city‚Ä¶" autocomplete="off" />
          <div class="confirm" id="confirm4"></div>
          <datalist id="list4"></datalist>
        </div>
        <div class="tile hidden" id="r4t0"><div class="tIcon" id="r4I0">‚Äî</div><div class="tHi" id="r4H0">‚Äî</div><div class="tLo" id="r4L0">‚Äî</div></div>
        <div class="tile hidden" id="r4t1"><div class="tIcon" id="r4I1">‚Äî</div><div class="tHi" id="r4H1">‚Äî</div><div class="tLo" id="r4L1">‚Äî</div></div>
        <div class="tile hidden" id="r4t2"><div class="tIcon" id="r4I2">‚Äî</div><div class="tHi" id="r4H2">‚Äî</div><div class="tLo" id="r4L2">‚Äî</div></div>
        <div class="tile hidden" id="r4t3"><div class="tIcon" id="r4I3">‚Äî</div><div class="tHi" id="r4H3">‚Äî</div><div class="tLo" id="r4L3">‚Äî</div></div>

        <!-- Row 5 (hidden) -->
        <div class="rowLeft hidden" id="rowLeft5">
          <p class="prompt">City #5</p>
          <input class="cityInput" id="loc5" placeholder="Enter a city‚Ä¶" autocomplete="off" />
          <div class="confirm" id="confirm5"></div>
          <datalist id="list5"></datalist>
        </div>
        <div class="tile hidden" id="r5t0"><div class="tIcon" id="r5I0">‚Äî</div><div class="tHi" id="r5H0">‚Äî</div><div class="tLo" id="r5L0">‚Äî</div></div>
        <div class="tile hidden" id="r5t1"><div class="tIcon" id="r5I1">‚Äî</div><div class="tHi" id="r5H1">‚Äî</div><div class="tLo" id="r5L1">‚Äî</div></div>
        <div class="tile hidden" id="r5t2"><div class="tIcon" id="r5I2">‚Äî</div><div class="tHi" id="r5H2">‚Äî</div><div class="tLo" id="r5L2">‚Äî</div></div>
        <div class="tile hidden" id="r5t3"><div class="tIcon" id="r5I3">‚Äî</div><div class="tHi" id="r5H3">‚Äî</div><div class="tLo" id="r5L3">‚Äî</div></div>
      </div>
    </section>
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);
    const cToF = (c)=> (c * 9/5) + 32;

    const US_STATE_ABBR = {
      "ALABAMA":"AL","ALASKA":"AK","ARIZONA":"AZ","ARKANSAS":"AR","CALIFORNIA":"CA",
      "COLORADO":"CO","CONNECTICUT":"CT","DELAWARE":"DE","FLORIDA":"FL","GEORGIA":"GA",
      "HAWAII":"HI","IDAHO":"ID","ILLINOIS":"IL","INDIANA":"IN","IOWA":"IA","KANSAS":"KS",
      "KENTUCKY":"KY","LOUISIANA":"LA","MAINE":"ME","MARYLAND":"MD","MASSACHUSETTS":"MA",
      "MICHIGAN":"MI","MINNESOTA":"MN","MISSISSIPPI":"MS","MISSOURI":"MO","MONTANA":"MT",
      "NEBRASKA":"NE","NEVADA":"NV","NEW HAMPSHIRE":"NH","NEW JERSEY":"NJ","NEW MEXICO":"NM",
      "NEW YORK":"NY","NORTH CAROLINA":"NC","NORTH DAKOTA":"ND","OHIO":"OH","OKLAHOMA":"OK",
      "OREGON":"OR","PENNSYLVANIA":"PA","RHODE ISLAND":"RI","SOUTH CAROLINA":"SC","SOUTH DAKOTA":"SD",
      "TENNESSEE":"TN","TEXAS":"TX","UTAH":"UT","VERMONT":"VT","VIRGINIA":"VA","WASHINGTON":"WA",
      "WEST VIRGINIA":"WV","WISCONSIN":"WI","WYOMING":"WY","DISTRICT OF COLUMBIA":"DC"
    };

    function toStateAbbr(admin1){
      const s = (admin1 || "").trim();
      if(!s) return "";
      if(s.length === 2 && /^[A-Za-z]{2}$/.test(s)) return s.toUpperCase();
      const key = s.toUpperCase();
      return US_STATE_ABBR[key] || s;
    }

    function formatConfirm(g){
      const city = (g.name || "").trim();
      const cc = (g.country_code || "").toUpperCase();
      const admin1 = (g.admin1 || "").trim();

      if(cc === "US"){
        const st = toStateAbbr(admin1);
        return st ? `${city}, ${st}` : city;
      }
      if(admin1) return `${city}, ${admin1}`;
      return city;
    }

    async function geocodeCity(query){
      const url = "https://geocoding-api.open-meteo.com/v1/search?count=6&language=en&format=json&name=" + encodeURIComponent(query);
      const r = await fetch(url);
      if(!r.ok) throw new Error("Geocoding failed");
      const j = await r.json();
      if(!j.results || !j.results.length) throw new Error("City not found");

      // Prefer US if present
      let g = j.results[0];
      const us = j.results.find(x => (x.country_code || "").toUpperCase() === "US");
      if(us) g = us;

      return { lat:g.latitude, lon:g.longitude, tz:g.timezone || "auto", confirm: formatConfirm(g), all:j.results };
    }

    async function fetchWeather(geo){
      const url =
        "https://api.open-meteo.com/v1/forecast" +
        `?latitude=${geo.lat}&longitude=${geo.lon}` +
        `&timezone=${encodeURIComponent(geo.tz || "auto")}` +
        `&current=${encodeURIComponent("temperature_2m,weathercode")}` +
        `&daily=${encodeURIComponent("temperature_2m_max,temperature_2m_min")}` +
        `&hourly=${encodeURIComponent("cloudcover,precipitation_probability,weathercode")}` +
        `&forecast_days=7` +
        "&temperature_unit=celsius";
      const r = await fetch(url);
      if(!r.ok) throw new Error("Forecast failed");
      return await r.json();
    }

    /* ===== Weighted icon for each day ===== */
    function hourWeight(localHour){
      const peak = 14;
      const span = 6;
      const w = 1 - Math.min(1, Math.abs(localHour - peak) / span);
      return Math.max(0, w);
    }

    function cloudIconBalanced(cloudAvg){
      if(cloudAvg < 20) return "‚òÄÔ∏è";
      if(cloudAvg < 45) return "üå§Ô∏è";
      if(cloudAvg < 70) return "‚õÖ";
      return "‚òÅÔ∏è";
    }

    function pickIconWeightedForDay(wx, dayStr){
      const times = wx?.hourly?.time;
      const cloud = wx?.hourly?.cloudcover;
      const pop = wx?.hourly?.precipitation_probability;
      const wcode = wx?.hourly?.weathercode;

      if(!Array.isArray(times) || !Array.isArray(cloud) || times.length !== cloud.length) return "‚Äî";

      let wSum = 0, cloudSum = 0;
      let popMax = 0;
      let thunderSeen = false;
      let snowSeen = false;

      for(let i=0;i<times.length;i++){
        const t = times[i];
        if(!t.startsWith(dayStr + "T")) continue;

        const hour = parseInt(t.slice(11,13), 10);
        if(hour < 8 || hour > 18) continue;

        const w = hourWeight(hour);
        if(w <= 0) continue;

        wSum += w;
        cloudSum += (cloud[i] ?? 0) * w;

        const p = Array.isArray(pop) ? (pop[i] ?? 0) : 0;
        if(p > popMax) popMax = p;

        const code = Array.isArray(wcode) ? wcode[i] : null;
        if(code != null){
          if([95,96,99].includes(code)) thunderSeen = true;
          if([71,73,75,77,85,86].includes(code)) snowSeen = true;
        }
      }

      if(wSum <= 0) return "‚Äî";

      const cloudAvg = cloudSum / wSum;

      if(thunderSeen && popMax >= 30) return "‚õàÔ∏è";
      if(snowSeen && popMax >= 25) return "üå®Ô∏è";
      if(popMax >= 45) return "üåßÔ∏è";

      return cloudIconBalanced(cloudAvg);
    }
    /* ===== /Weighted icon ===== */

    function set4DayHeader(dates, tz){
      // today-first indices 0..3
      for(let i=0;i<4;i++){
        const el = $("day"+i);
        if(!el) continue;

        const d = dates?.[i];
        if(!d){ el.textContent = "‚Äî"; continue; }

        const dt = new Date(d + "T12:00:00");
        const label = new Intl.DateTimeFormat("en-US", { weekday:"short", timeZone: tz || "UTC" }).format(dt);
        el.textContent = label;
      }
    }

    function fillDatalist(row, results){
      const dl = $("list"+row);
      if(!dl) return;
      dl.innerHTML = "";
      (results || []).slice(0,6).forEach(g=>{
        const opt = document.createElement("option");
        opt.value = formatConfirm(g);
        dl.appendChild(opt);
      });
      $("loc"+row).setAttribute("list", "list"+row);
    }

    function clearRow(row){
      $("confirm"+row).textContent = "";
      for(let i=0;i<4;i++){
        $("r"+row+"I"+i).textContent = "‚Äî";
        $("r"+row+"H"+i).textContent = "‚Äî";
        $("r"+row+"L"+i).textContent = "‚Äî";
      }
    }

    function setRow4DayIcons(row, wx){
      for(let i=0;i<4;i++){
        const dayStr = wx?.daily?.time?.[i];
        $("r"+row+"I"+i).textContent = dayStr ? pickIconWeightedForDay(wx, dayStr) : "‚Äî";
      }
    }

    function setRow4DayTemps(row, daily){
      const hi = daily?.temperature_2m_max;
      const lo = daily?.temperature_2m_min;

      for(let i=0;i<4;i++){
        const hEl = $("r"+row+"H"+i);
        const lEl = $("r"+row+"L"+i);

        if(!Array.isArray(hi) || !Array.isArray(lo) || hi.length < 4 || lo.length < 4){
          hEl.textContent = "‚Äî";
          lEl.textContent = "‚Äî";
          continue;
        }
        hEl.textContent = Math.round(cToF(hi[i])) + "¬∞";
        lEl.textContent = Math.round(cToF(lo[i])) + "¬∞";
      }
    }

    function showRow(row){
      $("rowLeft"+row).classList.remove("hidden");
      for(let i=0;i<4;i++){
        const t = $("r"+row+"t"+i);
        if(t) t.classList.remove("hidden");
      }
    }

    function nextHiddenRow(){
      for(let r=3;r<=5;r++){
        if($("rowLeft"+r).classList.contains("hidden")) return r;
      }
      return null;
    }

    const CACHE_KEY = "wxCompareCities_v2";
    function saveCities(){
      const arr = [];
      for(let r=1;r<=5;r++){
        const el = $("loc"+r);
        if(el) arr.push(el.value || "");
      }
      localStorage.setItem(CACHE_KEY, JSON.stringify(arr));
    }

    function loadCities(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return;
        const arr = JSON.parse(raw);
        if(!Array.isArray(arr)) return;
        for(let r=1;r<=5;r++){
          const el = $("loc"+r);
          if(el && typeof arr[r-1] === "string") el.value = arr[r-1];
        }
      }catch(e){}
    }

    function wireRow(row){
      const input = $("loc"+row);
      let timer = null;
      let lastToken = 0;

      async function run(){
        const token = ++lastToken;
        const q = input.value.trim();

        saveCities();

        if(!q){
          clearRow(row);
          return;
        }

        $("confirm"+row).textContent = "Finding city‚Ä¶";

        try{
          const geo = await geocodeCity(q);
          if(token !== lastToken) return;

          $("confirm"+row).textContent = geo.confirm;
          fillDatalist(row, geo.all);

          const wx = await fetchWeather(geo);
          if(token !== lastToken) return;

          // Shared header based on latest tz fetched (fine)
          set4DayHeader(wx.daily?.time, geo.tz);

          // Tiles only (no left-side icons/temps)
          setRow4DayIcons(row, wx);
          setRow4DayTemps(row, wx.daily);

        }catch(e){
          $("confirm"+row).textContent = "Could not resolve that city.";
          clearRow(row);
        }
      }

      function debounce(){
        if(timer) clearTimeout(timer);
        timer = setTimeout(run, 550);
      }

      input.addEventListener("input", debounce);
      input.addEventListener("change", run);
      input.addEventListener("keydown", (ev)=>{
        if(ev.key === "Enter"){
          ev.preventDefault();
          run();
          input.blur();
        }
      });

      return { run };
    }

    // boot
    loadCities();

    const wires = {};
    for(let r=1;r<=5;r++){
      wires[r] = wireRow(r);
      clearRow(r);
    }

    // reveal any saved rows 3-5
    for(let r=3;r<=5;r++){
      if(($("loc"+r).value || "").trim()){
        showRow(r);
      }
    }

    // run initial fills for any saved city values
    for(let r=1;r<=5;r++){
      if(($("loc"+r).value || "").trim()){
        wires[r].run();
      }
    }

    // Add city button under City #2
    $("addCityBtn").addEventListener("click", ()=>{
      const r = nextHiddenRow();
      if(!r){
        $("addCityBtn").textContent = "Max 5 cities";
        $("addCityBtn").disabled = true;
        $("addCityBtn").style.opacity = 0.6;
        return;
      }
      showRow(r);
      $("loc"+r).focus();
    });
  </script>
</body>
</html>
