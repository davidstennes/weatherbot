const url = "https://api.open-meteo.com/v1/forecast?latitude=35.1983&longitude=-111.6513&daily=weather_code,temperature_2m_max,temperature_2m_min,cloud_cover_mean,precipitation_probability_max,precipitation_sum,snowfall_sum&forecast_days=4&timezone=America%2FPhoenix&temperature_unit=fahrenheit";

const clamp = (x,min,max)=>Math.max(min,Math.min(max,x)));

function skyIcon4({ cloud, pop, precip_mm, snow_cm, code }) {
  // keep your 4-style rule: collapse special weather into cloudy
  if (code === 45 || code === 48) return "â˜ï¸"; // fog
  if (code >= 95) return "â˜ï¸";                 // thunder
  if ((snow_cm ?? 0) >= 0.2) return "â˜ï¸";       // snow
  if ((precip_mm ?? 0) >= 1.0) return "â˜ï¸";     // meaningful precip

  const sun_from_cloud = 1 - (cloud ?? 100)/100;
  const pop_ratio = (pop ?? 0)/100;
  const precip_amt_ratio = clamp((precip_mm ?? 0) / 1.0, 0, 1);
  const precip_penalty = Math.max(pop_ratio, precip_amt_ratio);

  const sun_score = clamp(sun_from_cloud * (1 - 0.6 * precip_penalty), 0, 1);

  if (sun_score >= 0.90) return "â˜€ï¸";
  if (sun_score >= 0.60) return "ðŸŒ¤ï¸";
  if (sun_score >= 0.30) return "ðŸŒ¥ï¸";
  return "â˜ï¸";
}

function dayName(dateStr){
  const d = new Date(dateStr + "T12:00:00");
  return d.toLocaleDateString(undefined, { weekday: "short" });
}

(async ()=>{
  const r = await fetch(url);
  const j = await r.json();
  const d = j.daily;

  for(let i=0;i<4;i++){
    const icon = skyIcon4({
      cloud: d.cloud_cover_mean?.[i],
      pop: d.precipitation_probability_max?.[i],
      precip_mm: d.precipitation_sum?.[i],
      snow_cm: d.snowfall_sum?.[i], // may be undefined sometimes; ok
      code: d.weather_code?.[i],
    });

    console.log(
      `${dayName(d.time[i])} ${d.time[i]}  ${icon}  High ${Math.round(d.temperature_2m_max[i])}Â°  Low ${Math.round(d.temperature_2m_min[i])}Â°`
    );
  }
})();
